<!DOCTYPE html>
<html class="writer-html5" lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>sdynpy.core.sdynpy_system &mdash; SDynPy 0.22.1 documentation</title>
      <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css" />
      <link rel="stylesheet" type="text/css" href="../../../_static/css/theme.css" />
      <link rel="stylesheet" type="text/css" href="../../../_static/plot_directive.css" />
      <link rel="stylesheet" type="text/css" href="../../../_static/copybutton.css" />
      <link rel="stylesheet" type="text/css" href="../../../_static/custom.css" />

  
  <!--[if lt IE 9]>
    <script src="../../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../../../" id="documentation_options" src="../../../_static/documentation_options.js"></script>
        <script src="../../../_static/jquery.js"></script>
        <script src="../../../_static/underscore.js"></script>
        <script src="../../../_static/_sphinx_javascript_frameworks_compat.js"></script>
        <script src="../../../_static/doctools.js"></script>
        <script src="../../../_static/sphinx_highlight.js"></script>
        <script src="../../../_static/clipboard.min.js"></script>
        <script src="../../../_static/copybutton.js"></script>
        <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <script src="../../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../../index.html">
            
              <img src="../../../_static/logo_horizontal_light.svg" class="logo" alt="Logo"/>
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../usage.html">Usage</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../sdynpy_showcase.html">SDynPy Showcase</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../core_functionality.html">Core Functionality</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../examples.html">SDynpy Examples</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../modal_tutorials.html">Modal Tutorials</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../modules.html">SDynPy Programming Interface</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../bibliography.html">Bibliography</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">SDynPy</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../../index.html">Module code</a></li>
      <li class="breadcrumb-item active">sdynpy.core.sdynpy_system</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for sdynpy.core.sdynpy_system</h1><div class="highlight"><pre>
<span></span><span class="c1"># -*- coding: utf-8 -*-</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Defines a system of matrices representing a structure.</span>

<span class="sd">The System consists of mass, stiffness, and (if necessary) damping matrices.</span>
<span class="sd">The System also contains a CoordinateArray defining the degrees of freedom of</span>
<span class="sd">the System, as well as a transformation that takes the System from its internal</span>
<span class="sd">state degrees of freedom to physical degrees of freedom.</span>

<span class="sd">Copyright 2022 National Technology &amp; Engineering Solutions of Sandia,</span>
<span class="sd">LLC (NTESS). Under the terms of Contract DE-NA0003525 with NTESS, the U.S.</span>
<span class="sd">Government retains certain rights in this software.</span>

<span class="sd">This program is free software: you can redistribute it and/or modify</span>
<span class="sd">it under the terms of the GNU General Public License as published by</span>
<span class="sd">the Free Software Foundation, either version 3 of the License, or</span>
<span class="sd">(at your option) any later version.</span>

<span class="sd">This program is distributed in the hope that it will be useful,</span>
<span class="sd">but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="sd">MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="sd">GNU General Public License for more details.</span>

<span class="sd">You should have received a copy of the GNU General Public License</span>
<span class="sd">along with this program.  If not, see &lt;https://www.gnu.org/licenses/&gt;.</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">.sdynpy_coordinate</span><span class="w"> </span><span class="kn">import</span> <span class="n">CoordinateArray</span><span class="p">,</span> <span class="n">from_nodelist</span><span class="p">,</span> <span class="n">outer_product</span><span class="p">,</span> <span class="n">coordinate_array</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">..fem.sdynpy_beam</span><span class="w"> </span><span class="kn">import</span> <span class="n">beamkm</span><span class="p">,</span> <span class="n">rect_beam_props</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">..fem.sdynpy_exodus</span><span class="w"> </span><span class="kn">import</span> <span class="n">Exodus</span><span class="p">,</span> <span class="n">ExodusInMemory</span><span class="p">,</span> <span class="n">reduce_exodus_to_surfaces</span><span class="p">,</span> <span class="n">read_sierra_matlab_matrix_file</span><span class="p">,</span> <span class="n">read_sierra_matlab_map_file</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">..fem.sdynpy_shaker</span><span class="w"> </span><span class="kn">import</span> <span class="n">Shaker4DoF</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">..signal_processing</span><span class="w"> </span><span class="kn">import</span> <span class="n">frf</span> <span class="k">as</span> <span class="n">spfrf</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">..signal_processing</span><span class="w"> </span><span class="kn">import</span> <span class="n">generator</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">scipy.linalg</span><span class="w"> </span><span class="kn">import</span> <span class="n">eigh</span><span class="p">,</span> <span class="n">block_diag</span><span class="p">,</span> <span class="n">null_space</span><span class="p">,</span> <span class="n">eig</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">scipy.signal</span><span class="w"> </span><span class="kn">import</span> <span class="n">lsim</span><span class="p">,</span> <span class="n">StateSpace</span><span class="p">,</span> <span class="n">resample</span><span class="p">,</span> <span class="n">butter</span><span class="p">,</span> <span class="n">filtfilt</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">copy</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">netCDF4</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">nc4</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">warnings</span>


<div class="viewcode-block" id="System"><a class="viewcode-back" href="../../../_autosummary/sdynpy.core.sdynpy_system.System.html#sdynpy.core.sdynpy_system.System">[docs]</a><span class="k">class</span><span class="w"> </span><span class="nc">System</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Matrix Equations representing a Structural Dynamics System&quot;&quot;&quot;</span>

<div class="viewcode-block" id="System.__init__"><a class="viewcode-back" href="../../../_autosummary/sdynpy.core.sdynpy_system.System.html#sdynpy.core.sdynpy_system.System.__init__">[docs]</a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">coordinate</span><span class="p">:</span> <span class="n">CoordinateArray</span><span class="p">,</span> <span class="n">mass</span><span class="p">,</span> <span class="n">stiffness</span><span class="p">,</span> <span class="n">damping</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">transformation</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">enforce_symmetry</span> <span class="o">=</span> <span class="kc">True</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Create a system representation including mass, stiffness, damping, and</span>
<span class="sd">        transformation matrices.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        coordinate : CoordinateArray</span>
<span class="sd">            Physical degrees of freedom in the system.</span>
<span class="sd">        mass : np.ndarray</span>
<span class="sd">            2D array consisting of the mass matrix of the system</span>
<span class="sd">        stiffness : np.ndarray</span>
<span class="sd">            2D array consisting of the stiffness matrix of the system</span>
<span class="sd">        damping : np.ndarray, optional</span>
<span class="sd">            2D array consisting of the damping matrix of the system.  If not</span>
<span class="sd">            specified, the damping will be zero.</span>
<span class="sd">        transformation : np.ndarray, optional</span>
<span class="sd">            A transformation between internal &quot;state&quot; degrees of freedom and</span>
<span class="sd">            the physical degrees of freedom defined in `coordinate`. The</span>
<span class="sd">            default transformation is the identity matrix.</span>
<span class="sd">        enforce_symmetry : bool, optional</span>
<span class="sd">            If True, raise a ValueError if the matrices provided are not</span>
<span class="sd">            symmetric.</span>

<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">        ValueError</span>
<span class="sd">            If inputs are improperly sized</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        None.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">mass</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_2d</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">mass</span><span class="p">))</span>
        <span class="n">stiffness</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_2d</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">stiffness</span><span class="p">))</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">mass</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="n">stiffness</span><span class="o">.</span><span class="n">shape</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Mass and Stiffness matrices must be the same shape&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">mass</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">2</span> <span class="ow">or</span> <span class="p">(</span><span class="n">mass</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="n">mass</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Mass should be a 2D, square array&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">stiffness</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">2</span> <span class="ow">or</span> <span class="p">(</span><span class="n">stiffness</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="n">stiffness</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Stiffness should be a 2D, square array&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">damping</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">damping</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">stiffness</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">damping</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_2d</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">damping</span><span class="p">))</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">damping</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="n">stiffness</span><span class="o">.</span><span class="n">shape</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Damping and Stiffness matrices must be the same shape&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">damping</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">2</span> <span class="ow">or</span> <span class="p">(</span><span class="n">damping</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="n">damping</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Damping should be a 2D, square array&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">transformation</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">transformation</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="n">mass</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">transformation</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_2d</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">transformation</span><span class="p">))</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">transformation</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;transformation must be 2D&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">transformation</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="n">mass</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s1">&#39;transformation must have number of columns equal to the number of rows in the mass matrix&#39;</span><span class="p">)</span>
        <span class="n">coordinate</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">coordinate</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">coordinate</span><span class="p">,</span> <span class="n">CoordinateArray</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;coordinate must be a CoordinateArray object&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">coordinate</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">or</span> <span class="n">coordinate</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="n">transformation</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s1">&#39;coordinate must be 1D and have the same size as transformation.shape[0] or mass.shape[0] if no transformation is specified&#39;</span><span class="p">)</span>
        <span class="c1"># Check symmetry</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">mass</span><span class="p">,</span> <span class="n">mass</span><span class="o">.</span><span class="n">T</span><span class="p">)</span> <span class="ow">and</span> <span class="n">enforce_symmetry</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;mass matrix must be symmetric&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">stiffness</span><span class="p">,</span> <span class="n">stiffness</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">atol</span><span class="o">=</span><span class="mf">1e-6</span><span class="o">*</span><span class="n">stiffness</span><span class="o">.</span><span class="n">max</span><span class="p">())</span> <span class="ow">and</span> <span class="n">enforce_symmetry</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;stiffness matrix must be symmetric&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">damping</span><span class="p">,</span> <span class="n">damping</span><span class="o">.</span><span class="n">T</span><span class="p">)</span> <span class="ow">and</span> <span class="n">enforce_symmetry</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;damping matrix must be symmetric&#39;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_coordinate</span> <span class="o">=</span> <span class="n">coordinate</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_mass</span> <span class="o">=</span> <span class="n">mass</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_stiffness</span> <span class="o">=</span> <span class="n">stiffness</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_damping</span> <span class="o">=</span> <span class="n">damping</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_transformation</span> <span class="o">=</span> <span class="n">transformation</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_enforce_symmetry</span> <span class="o">=</span> <span class="n">enforce_symmetry</span></div>

    <span class="k">def</span><span class="w"> </span><span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s1">&#39;System with </span><span class="si">{:}</span><span class="s1"> DoFs (</span><span class="si">{:}</span><span class="s1"> internal DoFs)&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ndof_transformed</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ndof</span><span class="p">)</span>

<div class="viewcode-block" id="System.spy"><a class="viewcode-back" href="../../../_autosummary/sdynpy.core.sdynpy_system.System.html#sdynpy.core.sdynpy_system.System.spy">[docs]</a>    <span class="k">def</span><span class="w"> </span><span class="nf">spy</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">subplots_kwargs</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;figsize&#39;</span><span class="p">:</span> <span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">3</span><span class="p">)},</span> <span class="n">spy_kwargs</span><span class="o">=</span><span class="p">{}):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Plot the structure of the system&#39;s matrices</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        subplots_kwargs : dict, optional</span>
<span class="sd">            Default arguments passed to `matplotlib.pyplot`&#39;s `subplots` function.</span>
<span class="sd">            The default is {&#39;figsize&#39;:(10,3)}.</span>
<span class="sd">        spy_kwargs : dict, optional</span>
<span class="sd">            Default arguments passed to `matplotlib.pyplot`&#39;s &#39;spy&#39; function.</span>
<span class="sd">            The default is {}.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        ax : Axes</span>
<span class="sd">            Axes on which the subplots are defined.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">squeeze</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="o">**</span><span class="n">subplots_kwargs</span><span class="p">)</span>
        <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">spy</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">transformation</span><span class="p">),</span> <span class="o">**</span><span class="n">spy_kwargs</span><span class="p">)</span>
        <span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">spy</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mass</span><span class="p">)</span> <span class="o">+</span> <span class="nb">abs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stiffness</span><span class="p">)</span> <span class="o">+</span> <span class="nb">abs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">damping</span><span class="p">),</span> <span class="o">**</span><span class="n">spy_kwargs</span><span class="p">)</span>
        <span class="n">ax</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">spy</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">transformation</span><span class="o">.</span><span class="n">T</span><span class="p">),</span> <span class="o">**</span><span class="n">spy_kwargs</span><span class="p">)</span>
        <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Output Transformation&#39;</span><span class="p">)</span>
        <span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Internal State Matrices&#39;</span><span class="p">)</span>
        <span class="n">ax</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Input Transformation&#39;</span><span class="p">)</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
        <span class="c1"># Trying to figure out how to scale the subfigures identically...</span>
        <span class="c1"># plt.pause(0.01)</span>
        <span class="c1"># # Now adjust the sizes of the plots</span>
        <span class="c1"># sizes = []</span>
        <span class="c1"># for a in ax:</span>
        <span class="c1">#     bbox = a.get_window_extent().transformed(fig.dpi_scale_trans.inverted())</span>
        <span class="c1">#     width, height = bbox.width, bbox.height</span>
        <span class="c1">#     sizes.append((width, height))</span>
        <span class="c1"># scales = [sizes[0][0],sizes[1][1],sizes[2][1]]</span>
        <span class="c1"># plt.pause(0.01)</span>
        <span class="c1"># scales = [scale/min(scales) for scale in scales]</span>
        <span class="c1"># for a,scale in zip(ax,scales):</span>
        <span class="c1">#     position = a.get_position()</span>
        <span class="c1">#     center_x = (position.xmax + position.xmin)/2</span>
        <span class="c1">#     center_y = (position.ymax + position.ymin)/2</span>
        <span class="c1">#     new_left = center_x - (center_x - position.xmin)/2</span>
        <span class="c1">#     new_bottom = center_y - (center_y - position.ymin)/2</span>
        <span class="c1">#     a.set_position([new_left,new_bottom,position.width/scale,position.height/scale])</span>
        <span class="k">return</span> <span class="n">ax</span></div>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">transformation</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get or set the transformation matrix&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_transformation</span>

    <span class="nd">@transformation</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">transformation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Set the transformation matrix&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">value</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;transformation must be 2D&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">value</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">mass</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s1">&#39;transformation must have number of columns equal to the number of rows in the mass matrix&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_transformation</span> <span class="o">=</span> <span class="n">value</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">coordinate</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get or set the degrees of freedom in the system&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_coordinate</span>

    <span class="nd">@coordinate</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">coordinate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Set the degrees of freedom in the system&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">CoordinateArray</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;coordinate must be a CoordinateArray object&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">value</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">or</span> <span class="n">value</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mass</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;coordinate must be 1D and have the same size as mass.shape[0]&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_coordinate</span> <span class="o">=</span> <span class="n">value</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">mass</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get or set the mass matrix of the system&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mass</span>

    <span class="nd">@mass</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">mass</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Set the mass matrix of the system&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">value</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">stiffness</span><span class="o">.</span><span class="n">shape</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Mass and Stiffness matrices must be the same shape&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">value</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">2</span> <span class="ow">or</span> <span class="p">(</span><span class="n">value</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="n">value</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Mass should be a 2D, square array&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">value</span><span class="o">.</span><span class="n">T</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_enforce_symmetry</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;mass matrix must be symmetric&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_mass</span> <span class="o">=</span> <span class="n">value</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">stiffness</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get or set the stffness matrix of the system&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_stiffness</span>

    <span class="nd">@stiffness</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">stiffness</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Set the stiffness matrix of the system&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">value</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">mass</span><span class="o">.</span><span class="n">shape</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Mass and Stiffness matrices must be the same shape&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">value</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">2</span> <span class="ow">or</span> <span class="p">(</span><span class="n">value</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="n">value</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Stiffness should be a 2D, square array&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">value</span><span class="o">.</span><span class="n">T</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_enforce_symmetry</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;stiffness matrix must be symmetric&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_stiffness</span> <span class="o">=</span> <span class="n">value</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">damping</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get or set the damping matrix of the system&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_damping</span>

    <span class="nd">@damping</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">damping</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Set the damping matrix of the system&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">value</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">stiffness</span><span class="o">.</span><span class="n">shape</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;damping and Stiffness matrices must be the same shape&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">value</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">2</span> <span class="ow">or</span> <span class="p">(</span><span class="n">value</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="n">value</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;damping should be a 2D, square array&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">value</span><span class="o">.</span><span class="n">T</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_enforce_symmetry</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;damping matrix must be symmetric&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_damping</span> <span class="o">=</span> <span class="n">value</span>

    <span class="n">M</span> <span class="o">=</span> <span class="n">mass</span>
    <span class="n">K</span> <span class="o">=</span> <span class="n">stiffness</span>
    <span class="n">C</span> <span class="o">=</span> <span class="n">damping</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">ndof</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get the number of internal degrees of freedom of the system&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">mass</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">ndof_transformed</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get the number of physical degrees of freedom of the system&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">transformation</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">massless_dofs</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Gets the massless degrees of freedom in the system&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mass</span> <span class="o">==</span> <span class="mi">0</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">massive_dofs</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="o">~</span><span class="bp">self</span><span class="o">.</span><span class="n">massless_dofs</span>

<div class="viewcode-block" id="System.to_state_space"><a class="viewcode-back" href="../../../_autosummary/sdynpy.core.sdynpy_system.System.html#sdynpy.core.sdynpy_system.System.to_state_space">[docs]</a>    <span class="k">def</span><span class="w"> </span><span class="nf">to_state_space</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">response_coordinates</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">excitation_coordinates</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                       <span class="n">output_excitation_signals</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="n">extra_outputs</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Creates state space matrices A, B, C, and D from a SDynPy System object</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        response_coordinates : dict, optional</span>
<span class="sd">            A dictionary with keys 0, 1, and 2 representing the displacement</span>
<span class="sd">            derivative and CoordinateArray values representing the degrees of</span>
<span class="sd">            freedom desired at that degree of freedom.  For example, a</span>
<span class="sd">            dictionary {0:sdpy.coordinate_array([101,102],[&#39;X+&#39;,&#39;X+&#39;]),</span>
<span class="sd">            2:sdpy.coordinate_array([203,204],[&#39;X+&#39;,&#39;Y+&#39;])} would give</span>
<span class="sd">            displacement results at 101X+ and 102X+ and acceleration results at</span>
<span class="sd">            203X+ and 204Y+.  The value of None can also be supplied to get all</span>
<span class="sd">            degrees of freedom at that derivative.  For example, {2:None} would</span>
<span class="sd">            get acceleration results at all degrees of freedom in the System.</span>
<span class="sd">            If not specified, the output will be given for displacement,</span>
<span class="sd">            velocity, and acceleration, for all degrees of freedom.  Rows of</span>
<span class="sd">            the output vector will be ordered first by derivative order then</span>
<span class="sd">            by degree of freedom order, so all displacements come before all</span>
<span class="sd">            velocities, and those before all accelerations.</span>
<span class="sd">        excitation_coordinates : CoordinateArray, optional</span>
<span class="sd">            The degrees of freedom to use as inputs in the state and output</span>
<span class="sd">            equations. The default is to provide inputs at all degrees of freedom.</span>
<span class="sd">        output_excitation_signals : bool, optional</span>
<span class="sd">            If True, the inputs to the system will be passed through and output</span>
<span class="sd">            as part of the output matrices C and D. The default is True.  These</span>
<span class="sd">            will be in the last rows of C and D, one for each of the excitation</span>
<span class="sd">            degrees of freedom.</span>
<span class="sd">        extra_outputs : dict</span>
<span class="sd">            A dictionary containing data to allow additional outputs to be</span>
<span class="sd">            obtained from the state space formulation.  The dictionary must</span>
<span class="sd">            have keys &#39;C&#39; and &#39;D&#39;.  These must contain NumPy ndarray objects that</span>
<span class="sd">            will be concatenated with the C and D matrices.  Both matrices</span>
<span class="sd">            should have number of rows equal to the number of extra outputs</span>
<span class="sd">            requested.  The number of columns of C should be equal to the</span>
<span class="sd">            number of states (2x number of massive degrees of freedom + 1x</span>
<span class="sd">            number of massless degrees of freedom).  States are ordered</span>
<span class="sd">            displacements of massive</span>
<span class="sd">            degrees of freedom, velocities of massive degrees of freedom,</span>
<span class="sd">            displacements of massless degrees of freedom.  Within each group,</span>
<span class="sd">            they will be ordered in the same order as the system matrices (not</span>
<span class="sd">            the transformation matrix).  The number of columns of the D matrix</span>
<span class="sd">            should be equivalent to the number of excitation coordinates</span>
<span class="sd">            provided.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        A : ndarray</span>
<span class="sd">            The state matrix.  States are ordered displacements of massive</span>
<span class="sd">            degrees of freedom, velocities of massive degrees of freedom,</span>
<span class="sd">            displacements of massless degrees of freedom.  Within each group,</span>
<span class="sd">            they will be ordered in the same order as the system matrices (not</span>
<span class="sd">            the transformation matrix).</span>
<span class="sd">        B : ndarray</span>
<span class="sd">            The input matrix.  Inputs are in the same order as the</span>
<span class="sd">            excitation_coordinate argument.  States are in the order as</span>
<span class="sd">            described for the A return value.</span>
<span class="sd">        C : ndarray</span>
<span class="sd">            The output matrix.  States are in the order as described for the A</span>
<span class="sd">            return value.  Outputs are ordered as follows: displacement</span>
<span class="sd">            responses, velocity responses, acceleration responses,</span>
<span class="sd">            excitation signals, extra outputs.  Within each group,</span>
<span class="sd">            the coordinates are ordered the same way as the provided</span>
<span class="sd">            response_coordinate and excitation_coordinate arguments.</span>
<span class="sd">        D : ndarray</span>
<span class="sd">            The feedforward matrix.  Input order is described in the return</span>
<span class="sd">            value for B.  Output order is described in the return value for C.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">response_coordinates</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">response_coordinates</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">coordinate</span><span class="p">,</span> <span class="mi">1</span><span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">coordinate</span><span class="p">,</span> <span class="mi">2</span><span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">coordinate</span><span class="p">}</span>
        <span class="n">phi_response</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">derivative</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">]:</span>
            <span class="k">if</span> <span class="n">derivative</span> <span class="ow">in</span> <span class="n">response_coordinates</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">response_coordinates</span><span class="p">[</span><span class="n">derivative</span><span class="p">],</span> <span class="nb">str</span><span class="p">)</span> <span class="ow">and</span> <span class="n">response_coordinates</span><span class="p">[</span><span class="n">derivative</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;state&#39;</span><span class="p">:</span>
                    <span class="c1"># If you want the state variables back, the transformation is the</span>
                    <span class="c1"># identity matrix.</span>
                    <span class="n">phi_response</span><span class="p">[</span><span class="n">derivative</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">transformation</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
                <span class="k">elif</span> <span class="n">response_coordinates</span><span class="p">[</span><span class="n">derivative</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">phi_response</span><span class="p">[</span><span class="n">derivative</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">transformation</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">phi_response</span><span class="p">[</span><span class="n">derivative</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">transformation_matrix_at_coordinates</span><span class="p">(</span><span class="n">response_coordinates</span><span class="p">[</span><span class="n">derivative</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">phi_response</span><span class="p">[</span><span class="n">derivative</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">transformation_matrix_at_coordinates</span><span class="p">(</span><span class="n">CoordinateArray</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">excitation_coordinates</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">phi_input</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">transformation</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">phi_input</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">transformation_matrix_at_coordinates</span><span class="p">(</span><span class="n">excitation_coordinates</span><span class="p">)</span>
        <span class="n">tdofs_input</span> <span class="o">=</span> <span class="n">phi_input</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="n">massless_dofs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mass</span> <span class="o">==</span> <span class="mi">0</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">ix_11</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ix_</span><span class="p">(</span><span class="o">~</span><span class="n">massless_dofs</span><span class="p">,</span><span class="o">~</span><span class="n">massless_dofs</span><span class="p">)</span>
        <span class="n">ix_12</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ix_</span><span class="p">(</span><span class="o">~</span><span class="n">massless_dofs</span><span class="p">,</span><span class="n">massless_dofs</span><span class="p">)</span>
        <span class="n">ix_22</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ix_</span><span class="p">(</span><span class="n">massless_dofs</span><span class="p">,</span><span class="n">massless_dofs</span><span class="p">)</span>
        <span class="n">ix_21</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ix_</span><span class="p">(</span><span class="n">massless_dofs</span><span class="p">,</span><span class="o">~</span><span class="n">massless_dofs</span><span class="p">)</span>
        <span class="n">n2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">massless_dofs</span><span class="p">)</span>
        <span class="n">n1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="o">~</span><span class="n">massless_dofs</span><span class="p">)</span>
        <span class="n">M_11</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mass</span><span class="p">[</span><span class="n">ix_11</span><span class="p">]</span>
        <span class="n">K_11</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stiffness</span><span class="p">[</span><span class="n">ix_11</span><span class="p">]</span>
        <span class="n">K_22</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stiffness</span><span class="p">[</span><span class="n">ix_22</span><span class="p">]</span>
        <span class="n">K_12</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stiffness</span><span class="p">[</span><span class="n">ix_12</span><span class="p">]</span>
        <span class="n">K_21</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stiffness</span><span class="p">[</span><span class="n">ix_21</span><span class="p">]</span>
        <span class="n">C_11</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">damping</span><span class="p">[</span><span class="n">ix_11</span><span class="p">]</span>
        <span class="n">C_22</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">damping</span><span class="p">[</span><span class="n">ix_22</span><span class="p">]</span>
        <span class="n">C_12</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">damping</span><span class="p">[</span><span class="n">ix_12</span><span class="p">]</span>
        <span class="n">C_21</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">damping</span><span class="p">[</span><span class="n">ix_21</span><span class="p">]</span>
        <span class="n">Z_11</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">n1</span><span class="p">,</span><span class="n">n1</span><span class="p">))</span>
        <span class="n">Z_12</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">n1</span><span class="p">,</span><span class="n">n2</span><span class="p">))</span>
        <span class="n">Z_1i</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">n1</span><span class="p">,</span><span class="n">tdofs_input</span><span class="p">))</span>
        <span class="n">Z_2i</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">n2</span><span class="p">,</span><span class="n">tdofs_input</span><span class="p">))</span>
        <span class="n">I_1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="n">n1</span><span class="p">)</span>
        <span class="n">I_i</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="n">tdofs_input</span><span class="p">)</span>
        <span class="n">Phi_i1</span> <span class="o">=</span> <span class="n">phi_input</span><span class="p">[:,</span><span class="o">~</span><span class="n">massless_dofs</span><span class="p">]</span>
        <span class="n">Phi_i2</span> <span class="o">=</span> <span class="n">phi_input</span><span class="p">[:,</span><span class="n">massless_dofs</span><span class="p">]</span>

        <span class="n">tdofs_response</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">Phi_r1</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">Phi_r2</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">Z_r1</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">Z_r2</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">Z_ri</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">derivative</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">]:</span>
            <span class="n">tdofs_response</span><span class="p">[</span><span class="n">derivative</span><span class="p">]</span> <span class="o">=</span> <span class="n">phi_response</span><span class="p">[</span><span class="n">derivative</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">Phi_r1</span><span class="p">[</span><span class="n">derivative</span><span class="p">]</span> <span class="o">=</span> <span class="n">phi_response</span><span class="p">[</span><span class="n">derivative</span><span class="p">][:,</span><span class="o">~</span><span class="n">massless_dofs</span><span class="p">]</span>
            <span class="n">Phi_r2</span><span class="p">[</span><span class="n">derivative</span><span class="p">]</span> <span class="o">=</span> <span class="n">phi_response</span><span class="p">[</span><span class="n">derivative</span><span class="p">][:,</span><span class="n">massless_dofs</span><span class="p">]</span>
            <span class="n">Z_r1</span><span class="p">[</span><span class="n">derivative</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">tdofs_response</span><span class="p">[</span><span class="n">derivative</span><span class="p">],</span><span class="n">n1</span><span class="p">))</span>
            <span class="n">Z_r2</span><span class="p">[</span><span class="n">derivative</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">tdofs_response</span><span class="p">[</span><span class="n">derivative</span><span class="p">],</span><span class="n">n2</span><span class="p">))</span>
            <span class="n">Z_ri</span><span class="p">[</span><span class="n">derivative</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">tdofs_response</span><span class="p">[</span><span class="n">derivative</span><span class="p">],</span><span class="n">tdofs_input</span><span class="p">))</span>

        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">Phi_r2</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">):</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s1">&#39;It looks like you are asking for the second order derivative of a degree of freedom that only has a first-order derivative defined.  Acceleration of massless degrees of freedom cannot be computed and will be set to zero.&#39;</span><span class="p">)</span>

        <span class="c1"># Degree of freedom ordering = [x1,v1,x2] (Disp 1, Vel 1, Disp 2)</span>
        <span class="c1"># Input ordering [V] (Voltages)</span>

        <span class="c1">#             # x1, v1, x2</span>
        <span class="n">A</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">block</span><span class="p">([[</span><span class="n">Z_11</span><span class="p">,</span><span class="n">I_1</span><span class="p">,</span> <span class="n">Z_12</span><span class="p">],</span>
                      <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span><span class="n">M_11</span><span class="p">,</span><span class="n">C_12</span><span class="p">)</span><span class="nd">@np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span><span class="n">C_22</span><span class="p">,</span><span class="n">K_21</span><span class="p">)</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span><span class="n">M_11</span><span class="p">,</span><span class="n">K_11</span><span class="p">),</span>
                       <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span><span class="n">M_11</span><span class="p">,</span><span class="n">C_11</span><span class="p">)</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span><span class="n">M_11</span><span class="p">,</span><span class="n">C_12</span><span class="p">)</span><span class="nd">@np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span><span class="n">C_22</span><span class="p">,</span><span class="n">C_21</span><span class="p">),</span>
                       <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span><span class="n">M_11</span><span class="p">,</span><span class="n">C_12</span><span class="p">)</span><span class="nd">@np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span><span class="n">C_22</span><span class="p">,</span><span class="n">K_22</span><span class="p">)</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span><span class="n">M_11</span><span class="p">,</span><span class="n">K_12</span><span class="p">)],</span>
                      <span class="p">[</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span><span class="n">C_22</span><span class="p">,</span><span class="n">K_21</span><span class="p">),</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span><span class="n">C_22</span><span class="p">,</span><span class="n">C_21</span><span class="p">),</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span><span class="n">C_22</span><span class="p">,</span><span class="n">K_22</span><span class="p">)]])</span>

        <span class="n">B</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">block</span><span class="p">([[</span><span class="n">Z_1i</span><span class="p">],</span>
                      <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span><span class="n">M_11</span><span class="p">,</span><span class="n">Phi_i1</span><span class="o">.</span><span class="n">T</span><span class="p">)</span><span class="o">+</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span><span class="n">M_11</span><span class="p">,</span><span class="n">C_12</span><span class="p">)</span><span class="nd">@np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span><span class="n">C_22</span><span class="p">,</span><span class="n">Phi_i2</span><span class="o">.</span><span class="n">T</span><span class="p">)],</span>
                      <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span><span class="n">C_22</span><span class="p">,</span><span class="n">Phi_i2</span><span class="o">.</span><span class="n">T</span><span class="p">)]])</span>

        <span class="c1"># Contributions from the massive degrees of freedom</span>
        <span class="n">C1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">block</span><span class="p">([</span>
            <span class="c1"># For displacements, just the states x1</span>
            <span class="p">[</span><span class="n">Phi_r1</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">Z_r1</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">Z_r2</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span>
            <span class="c1"># For velocities, just the states v1</span>
            <span class="p">[</span><span class="n">Z_r1</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">Phi_r1</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">Z_r2</span><span class="p">[</span><span class="mi">1</span><span class="p">]],</span>
            <span class="c1"># For acceleration, we want the row of A corresponding to v1dot</span>
            <span class="p">[</span><span class="n">Phi_r1</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">@</span> <span class="n">np</span><span class="o">.</span><span class="n">block</span><span class="p">([[</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span><span class="n">M_11</span><span class="p">,</span><span class="n">C_12</span><span class="p">)</span><span class="nd">@np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span><span class="n">C_22</span><span class="p">,</span><span class="n">K_21</span><span class="p">)</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span><span class="n">M_11</span><span class="p">,</span><span class="n">K_11</span><span class="p">),</span>
                                    <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span><span class="n">M_11</span><span class="p">,</span><span class="n">C_11</span><span class="p">)</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span><span class="n">M_11</span><span class="p">,</span><span class="n">C_12</span><span class="p">)</span><span class="nd">@np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span><span class="n">C_22</span><span class="p">,</span><span class="n">C_21</span><span class="p">),</span>
                                    <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span><span class="n">M_11</span><span class="p">,</span><span class="n">C_12</span><span class="p">)</span><span class="nd">@np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span><span class="n">C_22</span><span class="p">,</span><span class="n">K_22</span><span class="p">)</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span><span class="n">M_11</span><span class="p">,</span><span class="n">K_12</span><span class="p">)]])],</span>
            <span class="c1"># For the inputs, we pass through the inputs</span>
            <span class="p">[</span><span class="n">Z_1i</span><span class="o">.</span><span class="n">T</span><span class="p">,</span><span class="n">Z_1i</span><span class="o">.</span><span class="n">T</span><span class="p">,</span><span class="n">Z_2i</span><span class="o">.</span><span class="n">T</span><span class="p">]])</span>

        <span class="c1"># Contributions from the massless degrees of freedom</span>
        <span class="n">C2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">block</span><span class="p">([</span>
            <span class="c1"># For displacements, just the states x2</span>
            <span class="p">[</span><span class="n">Z_r1</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">Z_r1</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">Phi_r2</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span>
            <span class="c1"># For the velocities, we want the row of A corresponding to x2dot</span>
            <span class="p">[</span><span class="n">Phi_r2</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">@</span> <span class="n">np</span><span class="o">.</span><span class="n">block</span><span class="p">([[</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span><span class="n">C_22</span><span class="p">,</span><span class="n">K_21</span><span class="p">),</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span><span class="n">C_22</span><span class="p">,</span><span class="n">C_21</span><span class="p">),</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span><span class="n">C_22</span><span class="p">,</span><span class="n">K_22</span><span class="p">)]])],</span>
            <span class="c1"># For the accelerations, we will have zeros</span>
            <span class="p">[</span><span class="n">Z_r1</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">Z_r1</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">Z_r2</span><span class="p">[</span><span class="mi">2</span><span class="p">]],</span>
            <span class="c1"># For the inputs, we will pass through the inputs</span>
            <span class="p">[</span><span class="n">Z_1i</span><span class="o">.</span><span class="n">T</span><span class="p">,</span><span class="n">Z_1i</span><span class="o">.</span><span class="n">T</span><span class="p">,</span><span class="n">Z_2i</span><span class="o">.</span><span class="n">T</span><span class="p">]])</span>

        <span class="n">C</span> <span class="o">=</span> <span class="n">C1</span><span class="o">+</span><span class="n">C2</span>

        <span class="n">D</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">block</span><span class="p">([</span>
            <span class="c1"># For the displacements, we will have zeros</span>
            <span class="p">[</span><span class="n">Z_ri</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span>
            <span class="c1"># For the velocities, we want the row of B corresponding to x2dot</span>
            <span class="p">[</span><span class="n">Phi_r2</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">@</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span><span class="n">C_22</span><span class="p">,</span><span class="n">Phi_i2</span><span class="o">.</span><span class="n">T</span><span class="p">)],</span>
            <span class="c1"># For the accelerations, we want the row of B corresponding to v1dot</span>
            <span class="p">[</span><span class="n">Phi_r1</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">@</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span><span class="n">M_11</span><span class="p">,</span><span class="n">Phi_i1</span><span class="o">.</span><span class="n">T</span><span class="p">)</span><span class="o">+</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span><span class="n">M_11</span><span class="p">,</span><span class="n">C_12</span><span class="p">)</span><span class="nd">@np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span><span class="n">C_22</span><span class="p">,</span><span class="n">Phi_i2</span><span class="o">.</span><span class="n">T</span><span class="p">))],</span>
            <span class="c1"># For the inputs, we will pass through the inputs</span>
            <span class="p">[</span><span class="n">I_i</span><span class="p">]</span>
            <span class="p">])</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">output_excitation_signals</span><span class="p">:</span>
            <span class="n">C</span> <span class="o">=</span> <span class="n">C</span><span class="p">[:</span><span class="o">-</span><span class="n">tdofs_input</span><span class="p">]</span>
            <span class="n">D</span> <span class="o">=</span> <span class="n">D</span><span class="p">[:</span><span class="o">-</span><span class="n">tdofs_input</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">extra_outputs</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">C</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">C</span><span class="p">,</span><span class="n">extra_outputs</span><span class="p">[</span><span class="s1">&#39;C&#39;</span><span class="p">]))</span>
            <span class="n">D</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">D</span><span class="p">,</span><span class="n">extra_outputs</span><span class="p">[</span><span class="s1">&#39;D&#39;</span><span class="p">]))</span>

        <span class="k">return</span> <span class="n">A</span><span class="p">,</span><span class="n">B</span><span class="p">,</span><span class="n">C</span><span class="p">,</span><span class="n">D</span></div>

<div class="viewcode-block" id="System.time_integrate"><a class="viewcode-back" href="../../../_autosummary/sdynpy.core.sdynpy_system.System.html#sdynpy.core.sdynpy_system.System.time_integrate">[docs]</a>    <span class="k">def</span><span class="w"> </span><span class="nf">time_integrate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">forces</span><span class="p">,</span> <span class="n">responses</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                       <span class="n">initial_state</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                       <span class="n">integration_oversample</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">extra_outputs</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Integrate a system to produce responses to an excitation</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        forces : TimeHistoryArray</span>
<span class="sd">            The forces applied to the system, which should be a</span>
<span class="sd">            `TimeHistoryArray`.  The time step and excitation degrees of freedom</span>
<span class="sd">            will be taken from the `TimeHistoryArray`</span>
<span class="sd">        responses : dict, optional</span>
<span class="sd">            A dictionary with keys 0, 1, and 2 representing the displacement</span>
<span class="sd">            derivative and CoordinateArray values representing the degrees of</span>
<span class="sd">            freedom desired at that degree of freedom.  For example, a</span>
<span class="sd">            dictionary {0:sdpy.coordinate_array([101,102],[&#39;X+&#39;,&#39;X+&#39;]),</span>
<span class="sd">            2:sdpy.coordinate_array([203,204],[&#39;X+&#39;,&#39;Y+&#39;])} would give</span>
<span class="sd">            displacement results at 101X+ and 102X+ and acceleration results at</span>
<span class="sd">            203X+ and 204Y+.  The value of None can also be supplied to get all</span>
<span class="sd">            degrees of freedom at that derivative.  For example, {2:None} would</span>
<span class="sd">            get acceleration results at all degrees of freedom in the System.</span>
<span class="sd">            If not specified, the output will be given for displacement,</span>
<span class="sd">            velocity, and acceleration, for all degrees of freedom.  Rows of</span>
<span class="sd">            the output vector will be ordered first by derivative order then</span>
<span class="sd">            by degree of freedom order, so all displacements come before all</span>
<span class="sd">            velocities, and those before all accelerations.</span>
<span class="sd">        initial_state : np.ndarray, optional</span>
<span class="sd">            The initial conditions of the integration. The default is zero</span>
<span class="sd">            displacement and zero velocity.</span>
<span class="sd">        integration_oversample : int</span>
<span class="sd">            The amount of oversampling that will be applied to the force by</span>
<span class="sd">            zero-padding the fft.  It is generally better to create the forces</span>
<span class="sd">            such that they are oversampled than to use this argument.</span>
<span class="sd">        extra_outputs : dict</span>
<span class="sd">            A dictionary containing data to allow additional outputs to be</span>
<span class="sd">            obtained from the state space formulation.  The dictionary must</span>
<span class="sd">            have keys &#39;C&#39;, &#39;D&#39;, and &#39;coordinate&#39;.</span>
<span class="sd">            Values for &#39;C&#39; and &#39;D&#39; must contain NumPy ndarray objects that</span>
<span class="sd">            will be concatenated with the C and D matrices.  See the</span>
<span class="sd">            documentation for `to_state_space` for more information on these</span>
<span class="sd">            keys.  Additionally, the values of the &#39;coordinate&#39; key must</span>
<span class="sd">            contain a CoordinateArray object with the same size as the number</span>
<span class="sd">            of rows of C and D.  These will be assigned as the coordinates of</span>
<span class="sd">            the extra signals in the outputted TimeHistoryArray.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        response_array : TimeHistoryArray</span>
<span class="sd">            The responses of the system to the forces applied</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">from</span><span class="w"> </span><span class="nn">.sdynpy_data</span><span class="w"> </span><span class="kn">import</span> <span class="n">data_array</span><span class="p">,</span> <span class="n">FunctionTypes</span>
        <span class="n">dt</span> <span class="o">=</span> <span class="n">forces</span><span class="o">.</span><span class="n">abscissa_spacing</span>
        <span class="n">references</span> <span class="o">=</span> <span class="n">forces</span><span class="o">.</span><span class="n">coordinate</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
        <span class="n">forces</span> <span class="o">=</span> <span class="n">forces</span><span class="o">.</span><span class="n">ordinate</span>
        <span class="n">references</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">references</span><span class="p">)</span>
        <span class="n">A</span><span class="p">,</span> <span class="n">B</span><span class="p">,</span> <span class="n">C</span><span class="p">,</span> <span class="n">D</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">to_state_space</span><span class="p">(</span><span class="n">responses</span><span class="p">,</span> <span class="n">references</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span>
                                         <span class="n">extra_outputs</span><span class="o">=</span><span class="n">extra_outputs</span><span class="p">)</span>
        <span class="n">forces</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_2d</span><span class="p">(</span><span class="n">forces</span><span class="p">)</span>
        <span class="n">times</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">forces</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="o">*</span> <span class="n">dt</span>
        <span class="n">linear_system</span> <span class="o">=</span> <span class="n">StateSpace</span><span class="p">(</span><span class="n">A</span><span class="p">,</span> <span class="n">B</span><span class="p">,</span> <span class="n">C</span><span class="p">,</span> <span class="n">D</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">integration_oversample</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">forces</span><span class="p">,</span> <span class="n">times</span> <span class="o">=</span> <span class="n">resample</span><span class="p">(</span><span class="n">forces</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">times</span><span class="p">)</span> <span class="o">*</span> <span class="n">integration_oversample</span><span class="p">,</span> <span class="n">times</span><span class="p">,</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">times_out</span><span class="p">,</span> <span class="n">time_response</span><span class="p">,</span> <span class="n">x_out</span> <span class="o">=</span> <span class="n">lsim</span><span class="p">(</span><span class="n">linear_system</span><span class="p">,</span> <span class="n">forces</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">times</span><span class="p">,</span> <span class="n">initial_state</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">time_response</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">time_response</span> <span class="o">=</span> <span class="n">time_response</span><span class="p">[:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span>
        <span class="n">response_coordinates</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">responses</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">responses</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">coordinate</span><span class="p">,</span> <span class="mi">1</span><span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">coordinate</span><span class="p">,</span> <span class="mi">2</span><span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">coordinate</span><span class="p">}</span>
        <span class="k">for</span> <span class="n">derivative</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">]:</span>
            <span class="k">if</span> <span class="n">derivative</span> <span class="ow">in</span> <span class="n">responses</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">responses</span><span class="p">[</span><span class="n">derivative</span><span class="p">],</span> <span class="nb">str</span><span class="p">)</span> <span class="ow">and</span> <span class="n">responses</span><span class="p">[</span><span class="n">derivative</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;state&#39;</span><span class="p">:</span>
                    <span class="c1"># If you want the state variables back, the transformation is the</span>
                    <span class="c1"># identity matrix.</span>
                    <span class="n">response_coordinates</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">coordinate_array</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ndof</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">))</span>
                <span class="k">elif</span> <span class="n">responses</span><span class="p">[</span><span class="n">derivative</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">response_coordinates</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">coordinate</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">response_coordinates</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">responses</span><span class="p">[</span><span class="n">derivative</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">extra_outputs</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">response_coordinates</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">extra_outputs</span><span class="p">[</span><span class="s1">&#39;coordinate&#39;</span><span class="p">])</span>
        <span class="n">response_coordinates</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">response_coordinates</span><span class="p">)</span>
        <span class="n">response_array</span> <span class="o">=</span> <span class="n">data_array</span><span class="p">(</span><span class="n">FunctionTypes</span><span class="o">.</span><span class="n">TIME_RESPONSE</span><span class="p">,</span>
                                    <span class="n">times</span><span class="p">,</span> <span class="n">time_response</span><span class="o">.</span><span class="n">T</span><span class="p">,</span>
                                    <span class="n">response_coordinates</span><span class="p">[:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">integration_oversample</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">response_array</span> <span class="o">=</span> <span class="n">response_array</span><span class="o">.</span><span class="n">extract_elements</span><span class="p">(</span>
                <span class="nb">slice</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">integration_oversample</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">response_array</span></div>

<div class="viewcode-block" id="System.eigensolution"><a class="viewcode-back" href="../../../_autosummary/sdynpy.core.sdynpy_system.System.html#sdynpy.core.sdynpy_system.System.eigensolution">[docs]</a>    <span class="k">def</span><span class="w"> </span><span class="nf">eigensolution</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">num_modes</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">maximum_frequency</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">complex_modes</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">return_shape</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Computes the eigensolution of the system</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        num_modes : int, optional</span>
<span class="sd">            The number of modes of the system to compute. The default is to</span>
<span class="sd">            compute all the modes.</span>
<span class="sd">        maximum_frequency : float, optional</span>
<span class="sd">            The maximum frequency to which modes will be computed.</span>
<span class="sd">            The default is to compute all the modes.</span>
<span class="sd">        complex_modes : bool, optional</span>
<span class="sd">            Whether or not complex modes are computed. The default is False.</span>
<span class="sd">        return_shape : bool, optional</span>
<span class="sd">            Specifies whether or not to return a `ShapeArray` (True) or a reduced</span>
<span class="sd">            `System` (False). The default is True.</span>

<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">        NotImplementedError</span>
<span class="sd">            Raised if complex modes are specified.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        System or ShapeArray</span>
<span class="sd">            If `return_shape` is True, the a ShapeArray will be returned.  If</span>
<span class="sd">            `return_shape` is False, a reduced system will be returned.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">complex_modes</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">num_modes</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">num_modes</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">num_modes</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">maximum_frequency</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">maximum_frequency</span> <span class="o">=</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">maximum_frequency</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span>
                <span class="n">maximum_frequency</span> <span class="o">=</span> <span class="p">[</span><span class="o">-</span><span class="n">maximum_frequency</span><span class="p">,</span> <span class="n">maximum_frequency</span><span class="p">]</span>  <span class="c1"># Convert to eigenvalue</span>
            <span class="n">lam</span><span class="p">,</span> <span class="n">phi</span> <span class="o">=</span> <span class="n">eigh</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">K</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">M</span><span class="p">,</span> <span class="n">subset_by_index</span><span class="o">=</span><span class="n">num_modes</span><span class="p">,</span>
                            <span class="n">subset_by_value</span><span class="o">=</span><span class="n">maximum_frequency</span><span class="p">)</span>
            <span class="c1"># Mass normalize the mode shapes</span>
            <span class="n">lam</span><span class="p">[</span><span class="n">lam</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">freq</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">lam</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span>
            <span class="n">normalized_mass</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">phi</span><span class="o">.</span><span class="n">T</span> <span class="o">@</span> <span class="bp">self</span><span class="o">.</span><span class="n">M</span> <span class="o">@</span> <span class="n">phi</span><span class="p">)</span>
            <span class="n">phi</span> <span class="o">/=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">normalized_mass</span><span class="p">)</span>
            <span class="c1"># Ignore divide by zero if the frequency is zero</span>
            <span class="k">with</span> <span class="n">np</span><span class="o">.</span><span class="n">errstate</span><span class="p">(</span><span class="n">divide</span><span class="o">=</span><span class="s1">&#39;ignore&#39;</span><span class="p">,</span> <span class="n">invalid</span><span class="o">=</span><span class="s1">&#39;ignore&#39;</span><span class="p">):</span>
                <span class="n">damping</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">phi</span><span class="o">.</span><span class="n">T</span> <span class="o">@</span> <span class="bp">self</span><span class="o">.</span><span class="n">C</span> <span class="o">@</span> <span class="n">phi</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">freq</span><span class="p">))</span>
            <span class="n">damping</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">damping</span><span class="p">)]</span> <span class="o">=</span> <span class="mf">0.0</span>
            <span class="n">damping</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">isinf</span><span class="p">(</span><span class="n">damping</span><span class="p">)]</span> <span class="o">=</span> <span class="mf">0.0</span>
            <span class="c1"># Add in the transformation to get back to physical dofs</span>
            <span class="n">phi</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">transformation</span> <span class="o">@</span> <span class="n">phi</span>
            <span class="k">if</span> <span class="n">return_shape</span><span class="p">:</span>
                <span class="kn">from</span><span class="w"> </span><span class="nn">.sdynpy_shape</span><span class="w"> </span><span class="kn">import</span> <span class="n">shape_array</span>
                <span class="k">return</span> <span class="n">shape_array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">coordinate</span><span class="p">,</span> <span class="n">phi</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">freq</span><span class="p">,</span> <span class="n">damping</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">System</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">coordinate</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="n">freq</span><span class="o">.</span><span class="n">size</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">((</span><span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">freq</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">freq</span><span class="p">)</span> <span class="o">*</span> <span class="n">damping</span><span class="p">),</span> <span class="n">phi</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ndof</span> <span class="o">&gt;</span> <span class="mi">1000</span><span class="p">:</span>
                <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s1">&#39;The complex mode implementation currently computes all eigenvalues and eigenvectors, which may take a long time for large systems.&#39;</span><span class="p">)</span>
            <span class="c1"># For convenience, assign a zeros matrix</span>
            <span class="n">Z</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">M</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
            <span class="n">A</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">block</span><span class="p">([[</span>     <span class="n">Z</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">M</span><span class="p">],</span>
                          <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">M</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">C</span><span class="p">]])</span>
            <span class="n">B</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">block</span><span class="p">([[</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">M</span><span class="p">,</span>      <span class="n">Z</span><span class="p">],</span>
                          <span class="p">[</span>      <span class="n">Z</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">K</span><span class="p">]])</span>
            <span class="n">lam</span><span class="p">,</span> <span class="n">E</span> <span class="o">=</span> <span class="n">eig</span><span class="p">(</span><span class="o">-</span><span class="n">B</span><span class="p">,</span><span class="n">A</span><span class="p">)</span>
            <span class="c1"># Sort the eigenvalues such that they are increasing in frequency</span>
            <span class="n">isort</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">lam</span><span class="p">))</span>
            <span class="n">lam</span> <span class="o">=</span> <span class="n">lam</span><span class="p">[</span><span class="n">isort</span><span class="p">]</span>
            <span class="n">E</span> <span class="o">=</span> <span class="n">E</span><span class="p">[:,</span><span class="n">isort</span><span class="p">]</span>
            <span class="c1"># Eigenvalues will be in complex conjugate pairs.  Let&#39;s only keep</span>
            <span class="c1"># the ones that are greater than zero.</span>
            <span class="n">keep</span> <span class="o">=</span> <span class="n">lam</span><span class="o">.</span><span class="n">imag</span> <span class="o">&gt;</span> <span class="mi">0</span>
            <span class="n">lam</span> <span class="o">=</span> <span class="n">lam</span><span class="p">[</span><span class="n">keep</span><span class="p">]</span>
            <span class="n">E</span> <span class="o">=</span> <span class="n">E</span><span class="p">[:,</span><span class="n">keep</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">A</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">//</span><span class="mi">2</span> <span class="o">!=</span> <span class="n">lam</span><span class="o">.</span><span class="n">size</span><span class="p">:</span>
                <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s1">&#39;The complex mode implementation currently does not do well with rigid body modes (0 Hz frequencies).  Compute them from a real-modes solution then transform to complex.&#39;</span><span class="p">)</span>
            <span class="c1"># Cull values we don&#39;t want</span>
            <span class="k">if</span> <span class="n">num_modes</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">lam</span> <span class="o">=</span> <span class="n">lam</span><span class="p">[:</span><span class="n">num_modes</span><span class="p">]</span>
                <span class="n">E</span> <span class="o">=</span> <span class="n">E</span><span class="p">[:,:</span><span class="n">num_modes</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">maximum_frequency</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">keep</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">lam</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">maximum_frequency</span><span class="o">*</span><span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span>
                <span class="n">lam</span> <span class="o">=</span> <span class="n">lam</span><span class="p">[</span><span class="n">keep</span><span class="p">]</span>
                <span class="n">E</span> <span class="o">=</span> <span class="n">E</span><span class="p">[:,</span><span class="n">keep</span><span class="p">]</span>
            <span class="c1"># Mass normalize the mode shapes</span>
            <span class="n">E</span> <span class="o">=</span> <span class="n">E</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;ji,jk,ki-&gt;i&#39;</span><span class="p">,</span><span class="n">E</span><span class="p">,</span><span class="n">A</span><span class="p">,</span><span class="n">E</span><span class="p">))</span>
            <span class="c1"># Find repeated eigenvalues where the eigenvectors are not orthogonal</span>
            <span class="c1"># TODO: Might have to do some orthogonalization for repeated</span>
            <span class="c1"># eigenvalues</span>
            <span class="c1"># A_modal = np.einsum(&#39;ji,jk,kl-&gt;il&#39;,E,A,E)</span>
            <span class="c1"># Extract just the displacement partition</span>
            <span class="n">psi</span> <span class="o">=</span> <span class="n">E</span><span class="p">[</span><span class="n">E</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">//</span><span class="mi">2</span><span class="p">:,:]</span>
            <span class="c1"># Add in a transformation to get to physical dofs</span>
            <span class="n">psi_t</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">transformation</span> <span class="o">@</span> <span class="n">psi</span>
            <span class="n">frequency</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">lam</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span>
            <span class="n">damping</span> <span class="o">=</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">real</span><span class="p">(</span><span class="n">lam</span><span class="p">)</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">lam</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">return_shape</span><span class="p">:</span>
                <span class="kn">from</span><span class="w"> </span><span class="nn">.sdynpy_shape</span><span class="w"> </span><span class="kn">import</span> <span class="n">shape_array</span>
                <span class="k">return</span> <span class="n">shape_array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">coordinate</span><span class="p">,</span> <span class="n">psi</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">frequency</span><span class="p">,</span> <span class="n">damping</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s1">&#39;Complex Modes will in general not diagonalize the system M, C, and K, matrices.&#39;</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">System</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">coordinate</span><span class="p">,</span>
                              <span class="n">psi</span><span class="o">.</span><span class="n">T</span><span class="nd">@self</span><span class="o">.</span><span class="n">M</span><span class="nd">@psi</span><span class="p">,</span>
                              <span class="n">psi</span><span class="o">.</span><span class="n">T</span><span class="nd">@self</span><span class="o">.</span><span class="n">K</span><span class="nd">@psi</span><span class="o">.</span><span class="n">T</span><span class="p">,</span>
                              <span class="n">psi</span><span class="o">.</span><span class="n">T</span><span class="nd">@self</span><span class="o">.</span><span class="n">C</span><span class="nd">@psi</span><span class="o">.</span><span class="n">T</span><span class="p">,</span>
                              <span class="n">psi_t</span><span class="p">)</span></div>

<div class="viewcode-block" id="System.transformation_shapes"><a class="viewcode-back" href="../../../_autosummary/sdynpy.core.sdynpy_system.System.html#sdynpy.core.sdynpy_system.System.transformation_shapes">[docs]</a>    <span class="k">def</span><span class="w"> </span><span class="nf">transformation_shapes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">shape_indices</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="kn">from</span><span class="w"> </span><span class="nn">.sdynpy_shape</span><span class="w"> </span><span class="kn">import</span> <span class="n">shape_array</span>
        <span class="k">if</span> <span class="n">shape_indices</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">shape_indices</span> <span class="o">=</span> <span class="nb">slice</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
        <span class="n">shape_matrix</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">transformation</span><span class="p">[:,</span> <span class="n">shape_indices</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">shape_array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">coordinate</span><span class="p">,</span> <span class="n">shape_matrix</span><span class="o">.</span><span class="n">T</span><span class="p">,</span>
                           <span class="n">frequency</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">damping</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span></div>

<div class="viewcode-block" id="System.remove_transformation"><a class="viewcode-back" href="../../../_autosummary/sdynpy.core.sdynpy_system.System.html#sdynpy.core.sdynpy_system.System.remove_transformation">[docs]</a>    <span class="k">def</span><span class="w"> </span><span class="nf">remove_transformation</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">System</span><span class="p">(</span><span class="n">coordinate_array</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ndof</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">),</span>
                      <span class="bp">self</span><span class="o">.</span><span class="n">mass</span><span class="o">.</span><span class="n">copy</span><span class="p">(),</span><span class="bp">self</span><span class="o">.</span><span class="n">stiffness</span><span class="o">.</span><span class="n">copy</span><span class="p">(),</span><span class="bp">self</span><span class="o">.</span><span class="n">damping</span><span class="o">.</span><span class="n">copy</span><span class="p">())</span></div>

<div class="viewcode-block" id="System.frequency_response"><a class="viewcode-back" href="../../../_autosummary/sdynpy.core.sdynpy_system.System.html#sdynpy.core.sdynpy_system.System.frequency_response">[docs]</a>    <span class="k">def</span><span class="w"> </span><span class="nf">frequency_response</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">frequencies</span><span class="p">,</span> <span class="n">responses</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">references</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                           <span class="n">displacement_derivative</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Computes frequency response functions at the specified frequency lines.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        frequencies : ndarray</span>
<span class="sd">            A 1D array of frequencies.</span>
<span class="sd">        responses : CoordinateArray, optional</span>
<span class="sd">            A set of coordinates to compute responses. The default is to</span>
<span class="sd">            create responses at all coordinates.</span>
<span class="sd">        references : CoordinateArray, optional</span>
<span class="sd">            A set of coordinates to use as inputs. The default is to use all</span>
<span class="sd">            coordinates as inputs.</span>
<span class="sd">        displacement_derivative : int, optional</span>
<span class="sd">            The number of derivatives to apply to the response. The default is</span>
<span class="sd">            0, which corresponds to displacement.  1 would be the first</span>
<span class="sd">            derivative, velocity, and 2 would be the second derivative,</span>
<span class="sd">            acceleration.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        frf : TransferFunctionArray</span>
<span class="sd">            A TransferFunctionArray containing the frequency response function</span>
<span class="sd">            for the system at the specified input and output degrees of freedom.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">H</span> <span class="o">=</span> <span class="n">spfrf</span><span class="o">.</span><span class="n">sysmat2frf</span><span class="p">(</span><span class="n">frequencies</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">M</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">C</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">K</span><span class="p">)</span>
        <span class="n">H</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="n">j</span> <span class="o">*</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">frequencies</span><span class="p">[:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]))</span><span class="o">**</span><span class="n">displacement_derivative</span> <span class="o">*</span> <span class="n">H</span>
        <span class="c1"># Apply transformations</span>
        <span class="k">if</span> <span class="n">responses</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">output_transform</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">transformation</span>
            <span class="n">output_coordinates</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">coordinate</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">responses</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">responses</span><span class="p">)</span>
            <span class="n">output_transform</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">transformation_matrix_at_coordinates</span><span class="p">(</span><span class="n">responses</span><span class="p">)</span>
            <span class="n">output_coordinates</span> <span class="o">=</span> <span class="n">responses</span>
        <span class="k">if</span> <span class="n">references</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">input_transform</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">transformation</span>
            <span class="n">input_coordinates</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">coordinate</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">references</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">references</span><span class="p">)</span>
            <span class="n">input_transform</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">transformation_matrix_at_coordinates</span><span class="p">(</span><span class="n">references</span><span class="p">)</span>
            <span class="n">input_coordinates</span> <span class="o">=</span> <span class="n">references</span>
        <span class="n">H</span> <span class="o">=</span> <span class="n">output_transform</span> <span class="o">@</span> <span class="n">H</span> <span class="o">@</span> <span class="n">input_transform</span><span class="o">.</span><span class="n">T</span>
        <span class="c1"># Put it into a transfer function array</span>
        <span class="kn">from</span><span class="w"> </span><span class="nn">.sdynpy_data</span><span class="w"> </span><span class="kn">import</span> <span class="n">data_array</span><span class="p">,</span> <span class="n">FunctionTypes</span>
        <span class="n">frf</span> <span class="o">=</span> <span class="n">data_array</span><span class="p">(</span><span class="n">FunctionTypes</span><span class="o">.</span><span class="n">FREQUENCY_RESPONSE_FUNCTION</span><span class="p">,</span> <span class="n">frequencies</span><span class="p">,</span>
                         <span class="n">np</span><span class="o">.</span><span class="n">moveaxis</span><span class="p">(</span><span class="n">H</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">),</span>
                         <span class="n">outer_product</span><span class="p">(</span><span class="n">output_coordinates</span><span class="p">,</span> <span class="n">input_coordinates</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">frf</span></div>

<div class="viewcode-block" id="System.assign_modal_damping"><a class="viewcode-back" href="../../../_autosummary/sdynpy.core.sdynpy_system.System.html#sdynpy.core.sdynpy_system.System.assign_modal_damping">[docs]</a>    <span class="k">def</span><span class="w"> </span><span class="nf">assign_modal_damping</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">damping_ratios</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Assigns a damping matrix to the system that results in equivalent</span>
<span class="sd">        modal damping</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        damping_ratios : ndarray</span>
<span class="sd">            An array of damping values to assign to the system</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        None.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">damping_ratios</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">damping_ratios</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">damping_ratios</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">shapes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">eigensolution</span><span class="p">(</span><span class="n">num_modes</span><span class="o">=</span><span class="n">damping_ratios</span><span class="o">.</span><span class="n">size</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">shapes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">eigensolution</span><span class="p">()</span>
        <span class="n">shapes</span><span class="o">.</span><span class="n">damping</span> <span class="o">=</span> <span class="n">damping_ratios</span>
        <span class="c1"># Compute the damping matrix</span>
        <span class="n">modal_system</span> <span class="o">=</span> <span class="n">shapes</span><span class="o">.</span><span class="n">system</span><span class="p">()</span>
        <span class="n">shape_pinv</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">pinv</span><span class="p">(</span><span class="n">modal_system</span><span class="o">.</span><span class="n">transformation</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>
        <span class="n">full_damping_matrix</span> <span class="o">=</span> <span class="n">shape_pinv</span><span class="nd">@modal_system</span><span class="o">.</span><span class="n">damping</span><span class="nd">@shape_pinv</span><span class="o">.</span><span class="n">T</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">damping</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">full_damping_matrix</span></div>

<div class="viewcode-block" id="System.save"><a class="viewcode-back" href="../../../_autosummary/sdynpy.core.sdynpy_system.System.html#sdynpy.core.sdynpy_system.System.save">[docs]</a>    <span class="k">def</span><span class="w"> </span><span class="nf">save</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Saves the system to a file</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        filename : str</span>
<span class="sd">            Name of the file in which the system will be saved.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        None.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">np</span><span class="o">.</span><span class="n">savez</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">mass</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">mass</span><span class="p">,</span> <span class="n">stiffness</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">stiffness</span><span class="p">,</span> <span class="n">damping</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">damping</span><span class="p">,</span>
                 <span class="n">transformation</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">transformation</span><span class="p">,</span> <span class="n">coordinate</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">coordinate</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">),</span>
                 <span class="n">enforce_symmetry</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_enforce_symmetry</span><span class="p">)</span></div>

<div class="viewcode-block" id="System.load"><a class="viewcode-back" href="../../../_autosummary/sdynpy.core.sdynpy_system.System.html#sdynpy.core.sdynpy_system.System.load">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">load</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">filename</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Load a system from a file</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        filename : str</span>
<span class="sd">            Name of the file from which the system will be loaded.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        System</span>
<span class="sd">            A system consisting of the mass, stiffness, damping, and transformation</span>
<span class="sd">            in the file</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;coordinate&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="n">CoordinateArray</span><span class="p">),</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;mass&#39;</span><span class="p">],</span>
                   <span class="n">data</span><span class="p">[</span><span class="s1">&#39;stiffness&#39;</span><span class="p">],</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;damping&#39;</span><span class="p">],</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;transformation&#39;</span><span class="p">],</span>
                   <span class="kc">True</span> <span class="k">if</span> <span class="s1">&#39;enforce_symmetry&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">data</span> <span class="k">else</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;enforce_symmetry&#39;</span><span class="p">])</span></div>

    <span class="k">def</span><span class="w"> </span><span class="fm">__neg__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">new_system</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="n">new_system</span><span class="o">.</span><span class="n">mass</span> <span class="o">*=</span> <span class="o">-</span><span class="mi">1</span>
        <span class="n">new_system</span><span class="o">.</span><span class="n">stiffness</span> <span class="o">*=</span> <span class="o">-</span><span class="mi">1</span>
        <span class="n">new_system</span><span class="o">.</span><span class="n">damping</span> <span class="o">*=</span> <span class="o">-</span><span class="mi">1</span>
        <span class="k">return</span> <span class="n">new_system</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__mul__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="n">new_system</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="n">new_system</span><span class="o">.</span><span class="n">mass</span> <span class="o">*=</span> <span class="n">value</span>
        <span class="n">new_system</span><span class="o">.</span><span class="n">stiffness</span> <span class="o">*=</span> <span class="n">value</span>
        <span class="n">new_system</span><span class="o">.</span><span class="n">damping</span> <span class="o">*=</span> <span class="n">value</span>
        <span class="k">return</span> <span class="n">new_system</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__rmul__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="n">new_system</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="n">new_system</span><span class="o">.</span><span class="n">mass</span> <span class="o">*=</span> <span class="n">value</span>
        <span class="n">new_system</span><span class="o">.</span><span class="n">stiffness</span> <span class="o">*=</span> <span class="n">value</span>
        <span class="n">new_system</span><span class="o">.</span><span class="n">damping</span> <span class="o">*=</span> <span class="n">value</span>
        <span class="k">return</span> <span class="n">new_system</span>

<div class="viewcode-block" id="System.concatenate"><a class="viewcode-back" href="../../../_autosummary/sdynpy.core.sdynpy_system.System.html#sdynpy.core.sdynpy_system.System.concatenate">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">concatenate</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">systems</span><span class="p">,</span> <span class="n">coordinate_node_offset</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Combine multiple systems together</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        systems : iterable of System objects</span>
<span class="sd">            Iterable of Systems that will be concatenated.  Matrices will be</span>
<span class="sd">            assembled in block diagonal format</span>
<span class="sd">        coordinate_node_offset : int, optional</span>
<span class="sd">            Offset applied to the coordinates so the nodes do not overlap.</span>
<span class="sd">            The default is 0.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        System</span>
<span class="sd">            A system consisting of the combintation of the provided systems.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">coordinates</span> <span class="o">=</span> <span class="p">[</span><span class="n">system</span><span class="o">.</span><span class="n">coordinate</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span> <span class="k">for</span> <span class="n">system</span> <span class="ow">in</span> <span class="n">systems</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">coordinate_node_offset</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">coordinates</span><span class="p">)):</span>
                <span class="n">coordinates</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">node</span> <span class="o">+=</span> <span class="n">coordinate_node_offset</span> <span class="o">*</span> <span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">all_coordinates</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">coordinates</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span><span class="n">all_coordinates</span><span class="p">,</span>
                   <span class="n">block_diag</span><span class="p">(</span><span class="o">*</span><span class="p">[</span><span class="n">system</span><span class="o">.</span><span class="n">mass</span> <span class="k">for</span> <span class="n">system</span> <span class="ow">in</span> <span class="n">systems</span><span class="p">]),</span>
                   <span class="n">block_diag</span><span class="p">(</span><span class="o">*</span><span class="p">[</span><span class="n">system</span><span class="o">.</span><span class="n">stiffness</span> <span class="k">for</span> <span class="n">system</span> <span class="ow">in</span> <span class="n">systems</span><span class="p">]),</span>
                   <span class="n">block_diag</span><span class="p">(</span><span class="o">*</span><span class="p">[</span><span class="n">system</span><span class="o">.</span><span class="n">damping</span> <span class="k">for</span> <span class="n">system</span> <span class="ow">in</span> <span class="n">systems</span><span class="p">]),</span>
                   <span class="n">block_diag</span><span class="p">(</span><span class="o">*</span><span class="p">[</span><span class="n">system</span><span class="o">.</span><span class="n">transformation</span> <span class="k">for</span> <span class="n">system</span> <span class="ow">in</span> <span class="n">systems</span><span class="p">]),</span>
                   <span class="n">enforce_symmetry</span> <span class="o">=</span> <span class="kc">True</span> <span class="k">if</span> <span class="nb">all</span><span class="p">([</span><span class="n">s</span><span class="o">.</span><span class="n">_enforce_symmetry</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">systems</span><span class="p">])</span> <span class="k">else</span> <span class="kc">False</span><span class="p">)</span></div>

<div class="viewcode-block" id="System.substructure_by_position"><a class="viewcode-back" href="../../../_autosummary/sdynpy.core.sdynpy_system.System.html#sdynpy.core.sdynpy_system.System.substructure_by_position">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">substructure_by_position</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">systems</span><span class="p">,</span> <span class="n">geometries</span><span class="p">,</span> <span class="n">distance_threshold</span><span class="o">=</span><span class="mf">1e-8</span><span class="p">,</span> <span class="n">rcond</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Applies constraints to systems by constraining colocated nodes together</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        systems : iterable of System objects</span>
<span class="sd">            A set of systems that will be combined and constrained together</span>
<span class="sd">        geometries : iterable of Geometry objects</span>
<span class="sd">            A set of geometries that will be combined together</span>
<span class="sd">        distance_threshold : float, optional</span>
<span class="sd">            The distance between nodes that are considered colocated.</span>
<span class="sd">            The default is 1e-8.</span>
<span class="sd">        rcond : float, optional</span>
<span class="sd">            Condition number to use in the nullspace calculation on</span>
<span class="sd">            the constraint matrix. The default is None.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        combined_system : System</span>
<span class="sd">            System consisting of constraining the input systems together.</span>
<span class="sd">        combined_geometry : Geometry</span>
<span class="sd">            Combined geometry of the new system</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">from</span><span class="w"> </span><span class="nn">.sdynpy_geometry</span><span class="w"> </span><span class="kn">import</span> <span class="n">Geometry</span>
        <span class="n">combined_geometry</span><span class="p">,</span> <span class="n">node_offset</span> <span class="o">=</span> <span class="n">Geometry</span><span class="o">.</span><span class="n">overlay_geometries</span><span class="p">(</span>
            <span class="n">geometries</span><span class="p">,</span> <span class="n">return_node_id_offset</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">combined_system</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">systems</span><span class="p">,</span> <span class="n">node_offset</span><span class="p">)</span>
        <span class="n">global_coords</span> <span class="o">=</span> <span class="n">combined_geometry</span><span class="o">.</span><span class="n">global_node_coordinate</span><span class="p">()</span>
        <span class="n">node_distances</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span>
            <span class="n">global_coords</span><span class="p">[:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="p">:]</span> <span class="o">-</span> <span class="n">global_coords</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:],</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
        <span class="c1"># Find locations where the value is less than the tolerances, except for on the centerline</span>
        <span class="n">node_pairs</span> <span class="o">=</span> <span class="p">[[</span><span class="n">combined_geometry</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">id</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="k">for</span> <span class="n">index</span> <span class="ow">in</span> <span class="n">pair</span><span class="p">]</span>
                      <span class="k">for</span> <span class="n">pair</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">node_distances</span> <span class="o">&lt;</span> <span class="n">distance_threshold</span><span class="p">))</span> <span class="k">if</span> <span class="n">pair</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">pair</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span>
        <span class="c1"># Find matching DoF pairs</span>
        <span class="n">constraint_matrix</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">node1</span><span class="p">,</span> <span class="n">node2</span> <span class="ow">in</span> <span class="n">node_pairs</span><span class="p">:</span>
            <span class="c1"># Find the dofs associated with each node</span>
            <span class="n">system_1_dof_indices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">combined_system</span><span class="o">.</span><span class="n">coordinate</span><span class="o">.</span><span class="n">node</span> <span class="o">==</span> <span class="n">node1</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">system_1_dofs</span> <span class="o">=</span> <span class="n">combined_system</span><span class="o">.</span><span class="n">coordinate</span><span class="p">[</span><span class="n">system_1_dof_indices</span><span class="p">]</span>
            <span class="n">system_1_transformation</span> <span class="o">=</span> <span class="n">combined_system</span><span class="o">.</span><span class="n">transformation</span><span class="p">[</span><span class="n">system_1_dof_indices</span><span class="p">]</span>
            <span class="n">global_deflections_1</span> <span class="o">=</span> <span class="n">combined_geometry</span><span class="o">.</span><span class="n">global_deflection</span><span class="p">(</span><span class="n">system_1_dofs</span><span class="p">)</span>
            <span class="n">system_2_dof_indices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">combined_system</span><span class="o">.</span><span class="n">coordinate</span><span class="o">.</span><span class="n">node</span> <span class="o">==</span> <span class="n">node2</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">system_2_dofs</span> <span class="o">=</span> <span class="n">combined_system</span><span class="o">.</span><span class="n">coordinate</span><span class="p">[</span><span class="n">system_2_dof_indices</span><span class="p">]</span>
            <span class="n">system_2_transformation</span> <span class="o">=</span> <span class="n">combined_system</span><span class="o">.</span><span class="n">transformation</span><span class="p">[</span><span class="n">system_2_dof_indices</span><span class="p">]</span>
            <span class="n">global_deflections_2</span> <span class="o">=</span> <span class="n">combined_geometry</span><span class="o">.</span><span class="n">global_deflection</span><span class="p">(</span><span class="n">system_2_dofs</span><span class="p">)</span>
            <span class="c1"># Split between translations and rotations</span>
            <span class="n">translation_map_1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">((</span><span class="nb">abs</span><span class="p">(</span><span class="n">system_1_dofs</span><span class="o">.</span><span class="n">direction</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">3</span><span class="p">)</span>
                                         <span class="o">&amp;</span> <span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">system_1_dofs</span><span class="o">.</span><span class="n">direction</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">))</span>
            <span class="n">rotation_map_1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">system_1_dofs</span><span class="o">.</span><span class="n">direction</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">3</span><span class="p">)</span>
            <span class="n">translation_map_2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">((</span><span class="nb">abs</span><span class="p">(</span><span class="n">system_2_dofs</span><span class="o">.</span><span class="n">direction</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">3</span><span class="p">)</span>
                                         <span class="o">&amp;</span> <span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">system_2_dofs</span><span class="o">.</span><span class="n">direction</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">))</span>
            <span class="n">rotation_map_2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">system_2_dofs</span><span class="o">.</span><span class="n">direction</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">3</span><span class="p">)</span>
            <span class="n">neutral_map_1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">system_1_dofs</span><span class="o">.</span><span class="n">direction</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
            <span class="n">neutral_map_2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">system_2_dofs</span><span class="o">.</span><span class="n">direction</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
            <span class="c1"># Do translations and rotations separately</span>
            <span class="k">for</span> <span class="n">map_1</span><span class="p">,</span> <span class="n">map_2</span> <span class="ow">in</span> <span class="p">[[</span><span class="n">translation_map_1</span><span class="p">,</span> <span class="n">translation_map_2</span><span class="p">],</span>
                                 <span class="p">[</span><span class="n">rotation_map_1</span><span class="p">,</span> <span class="n">rotation_map_2</span><span class="p">],</span>
                                 <span class="p">[</span><span class="n">neutral_map_1</span><span class="p">,</span> <span class="n">neutral_map_2</span><span class="p">]]:</span>
                <span class="n">deflections_1</span> <span class="o">=</span> <span class="n">global_deflections_1</span><span class="p">[</span><span class="n">map_1</span><span class="p">]</span><span class="o">.</span><span class="n">T</span>
                <span class="n">deflections_2</span> <span class="o">=</span> <span class="n">global_deflections_2</span><span class="p">[</span><span class="n">map_2</span><span class="p">]</span><span class="o">.</span><span class="n">T</span>
                <span class="n">transform_1</span> <span class="o">=</span> <span class="n">system_1_transformation</span><span class="p">[</span><span class="n">map_1</span><span class="p">]</span>
                <span class="n">transform_2</span> <span class="o">=</span> <span class="n">system_2_transformation</span><span class="p">[</span><span class="n">map_2</span><span class="p">]</span>
                <span class="n">full_constraint</span> <span class="o">=</span> <span class="n">deflections_1</span> <span class="o">@</span> <span class="n">transform_1</span> <span class="o">-</span> <span class="n">deflections_2</span> <span class="o">@</span> <span class="n">transform_2</span>
                <span class="n">constraint_matrix</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">full_constraint</span><span class="p">)</span>
        <span class="n">constraint_matrix</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">constraint_matrix</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">combined_system</span><span class="o">.</span><span class="n">constrain</span><span class="p">(</span><span class="n">constraint_matrix</span><span class="p">,</span> <span class="n">rcond</span><span class="p">),</span> <span class="n">combined_geometry</span></div>

<div class="viewcode-block" id="System.constrain"><a class="viewcode-back" href="../../../_autosummary/sdynpy.core.sdynpy_system.System.html#sdynpy.core.sdynpy_system.System.constrain">[docs]</a>    <span class="k">def</span><span class="w"> </span><span class="nf">constrain</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">constraint_matrix</span><span class="p">,</span> <span class="n">rcond</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Apply a constraint matrix to the system</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        constraint_matrix : np.ndarray</span>
<span class="sd">            A matrix of constraints to apply to the structure (B matrix in</span>
<span class="sd">            substructuring literature)</span>
<span class="sd">        rcond : float, optional</span>
<span class="sd">            Condition tolerance for computing the nullspace. The default is None.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        System</span>
<span class="sd">            Constrained system.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">substructuring_transform_matrix</span> <span class="o">=</span> <span class="n">null_space</span><span class="p">(</span><span class="n">constraint_matrix</span><span class="p">,</span> <span class="n">rcond</span><span class="p">)</span>
        <span class="n">new_mass</span> <span class="o">=</span> <span class="n">substructuring_transform_matrix</span><span class="o">.</span><span class="n">T</span> <span class="o">@</span> <span class="bp">self</span><span class="o">.</span><span class="n">mass</span> <span class="o">@</span> <span class="n">substructuring_transform_matrix</span>
        <span class="n">new_stiffness</span> <span class="o">=</span> <span class="n">substructuring_transform_matrix</span><span class="o">.</span><span class="n">T</span> <span class="o">@</span> <span class="bp">self</span><span class="o">.</span><span class="n">stiffness</span> <span class="o">@</span> <span class="n">substructuring_transform_matrix</span>
        <span class="n">new_damping</span> <span class="o">=</span> <span class="n">substructuring_transform_matrix</span><span class="o">.</span><span class="n">T</span> <span class="o">@</span> <span class="bp">self</span><span class="o">.</span><span class="n">damping</span> <span class="o">@</span> <span class="n">substructuring_transform_matrix</span>
        <span class="n">new_transform</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">transformation</span> <span class="o">@</span> <span class="n">substructuring_transform_matrix</span>
        <span class="k">return</span> <span class="n">System</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">coordinate</span><span class="p">,</span> <span class="n">new_mass</span><span class="p">,</span> <span class="n">new_stiffness</span><span class="p">,</span> <span class="n">new_damping</span><span class="p">,</span> <span class="n">new_transform</span><span class="p">,</span>
                      <span class="n">enforce_symmetry</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_enforce_symmetry</span><span class="p">)</span></div>

<div class="viewcode-block" id="System.transformation_matrix_at_coordinates"><a class="viewcode-back" href="../../../_autosummary/sdynpy.core.sdynpy_system.System.html#sdynpy.core.sdynpy_system.System.transformation_matrix_at_coordinates">[docs]</a>    <span class="k">def</span><span class="w"> </span><span class="nf">transformation_matrix_at_coordinates</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">coordinates</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return the transformation matrix at the specified coordinates</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        coordinates : CoordinateArray</span>
<span class="sd">            coordinates at which the transformation matrix will be computed.</span>

<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">        ValueError</span>
<span class="sd">            Raised if duplicate coordinates are requested, or if coordinates that</span>
<span class="sd">            do not exist in the system are requested.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        return_value : np.ndarray</span>
<span class="sd">            Portion of the transformation matrix corresponding to the</span>
<span class="sd">            coordinates input to the function.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">consistent_arrays</span><span class="p">,</span> <span class="n">shape_indices</span><span class="p">,</span> <span class="n">request_indices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">intersect1d</span><span class="p">(</span>
            <span class="nb">abs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">coordinate</span><span class="p">),</span> <span class="nb">abs</span><span class="p">(</span><span class="n">coordinates</span><span class="p">),</span> <span class="n">assume_unique</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">return_indices</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="c1"># Make sure that all of the keys are actually in the consistent array matrix</span>
        <span class="k">if</span> <span class="n">consistent_arrays</span><span class="o">.</span><span class="n">size</span> <span class="o">!=</span> <span class="n">coordinates</span><span class="o">.</span><span class="n">size</span><span class="p">:</span>
            <span class="n">extra_keys</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">setdiff1d</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">coordinates</span><span class="p">),</span> <span class="nb">abs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">coordinate</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">extra_keys</span><span class="o">.</span><span class="n">size</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="s1">&#39;Duplicate coordinate values requested.  Please ensure coordinate indices are unique.&#39;</span><span class="p">)</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s1">&#39;Not all indices in requested coordinate array exist in the system</span><span class="se">\n</span><span class="si">{:}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">extra_keys</span><span class="p">)))</span>
        <span class="c1"># Handle sign flipping</span>
        <span class="n">multiplications</span> <span class="o">=</span> <span class="n">coordinates</span><span class="o">.</span><span class="n">flatten</span><span class="p">()[</span><span class="n">request_indices</span><span class="p">]</span><span class="o">.</span><span class="n">sign</span><span class="p">(</span>
        <span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">coordinate</span><span class="p">[</span><span class="n">shape_indices</span><span class="p">]</span><span class="o">.</span><span class="n">sign</span><span class="p">()</span>
        <span class="n">return_value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">transformation</span><span class="p">[</span><span class="n">shape_indices</span><span class="p">]</span> <span class="o">*</span> <span class="n">multiplications</span><span class="p">[:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span>
        <span class="c1"># Invert the indices to return the dofs in the correct order as specified in keys</span>
        <span class="n">inverse_indices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">request_indices</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
        <span class="n">inverse_indices</span><span class="p">[</span><span class="n">request_indices</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">request_indices</span><span class="p">))</span>
        <span class="n">return_value</span> <span class="o">=</span> <span class="n">return_value</span><span class="p">[</span><span class="n">inverse_indices</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">return_value</span></div>

<div class="viewcode-block" id="System.substructure_by_coordinate"><a class="viewcode-back" href="../../../_autosummary/sdynpy.core.sdynpy_system.System.html#sdynpy.core.sdynpy_system.System.substructure_by_coordinate">[docs]</a>    <span class="k">def</span><span class="w"> </span><span class="nf">substructure_by_coordinate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dof_pairs</span><span class="p">,</span> <span class="n">rcond</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                   <span class="n">return_constrained_system</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Constrain the system by connecting the specified degree of freedom pairs</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        dof_pairs : iterable of CoordinateArray</span>
<span class="sd">            Pairs of coordinates to be connected.  None can be passed instead of</span>
<span class="sd">            a second degree of freedom to constrain to ground</span>
<span class="sd">        rcond : float, optional</span>
<span class="sd">            Condition threshold to use for the nullspace calculation on the</span>
<span class="sd">            constraint matrix. The default is None.</span>
<span class="sd">        return_constrained_system : bool, optional</span>
<span class="sd">            If true, apply the constraint matrix and return the constrained</span>
<span class="sd">            system, otherwise simply return the constraint matrix. The default</span>
<span class="sd">            is True.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        np.ndarray or System</span>
<span class="sd">            Returns a System object with the constraints applied if</span>
<span class="sd">            `return_constrained_system` is True, otherwise just return the</span>
<span class="sd">            constraint matrix.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">constraint_matrix</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">constraint_dof_0</span><span class="p">,</span> <span class="n">constraint_dof_1</span> <span class="ow">in</span> <span class="n">dof_pairs</span><span class="p">:</span>
            <span class="n">constraint</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">transformation_matrix_at_coordinates</span><span class="p">(</span><span class="n">constraint_dof_0</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">constraint_dof_1</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">constraint</span> <span class="o">-=</span> <span class="bp">self</span><span class="o">.</span><span class="n">transformation_matrix_at_coordinates</span><span class="p">(</span><span class="n">constraint_dof_1</span><span class="p">)</span>
            <span class="n">constraint_matrix</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">constraint</span><span class="p">)</span>
        <span class="n">constraint_matrix</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">constraint_matrix</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">return_constrained_system</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">constrain</span><span class="p">(</span><span class="n">constraint_matrix</span><span class="p">,</span> <span class="n">rcond</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">constraint_matrix</span></div>

<div class="viewcode-block" id="System.substructure_by_shape"><a class="viewcode-back" href="../../../_autosummary/sdynpy.core.sdynpy_system.System.html#sdynpy.core.sdynpy_system.System.substructure_by_shape">[docs]</a>    <span class="k">def</span><span class="w"> </span><span class="nf">substructure_by_shape</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">constraint_shapes</span><span class="p">,</span> <span class="n">connection_dofs_0</span><span class="p">,</span>
                              <span class="n">connection_dofs_1</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">rcond</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                              <span class="n">return_constrained_system</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Constrain the system using a set of shapes in a least-squares sense.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        constraint_shapes : ShapeArray</span>
<span class="sd">            An array of shapes to use as the basis for the constraints</span>
<span class="sd">        connection_dofs_0 : CoordinateArray</span>
<span class="sd">            Array of coordinates to use in the constraints</span>
<span class="sd">        connection_dofs_1 : CoordinateArray, optional</span>
<span class="sd">            Array of coordinates to constrain to the coordinates in</span>
<span class="sd">            `connection_dofs_0`. If not specified, the `connection_dofs_0`</span>
<span class="sd">            degrees of freedom will be constrained to ground.</span>
<span class="sd">        rcond : float, optional</span>
<span class="sd">            Condition threshold on the nullspace calculation. The default is None.</span>
<span class="sd">        return_constrained_system : bool, optional</span>
<span class="sd">            If true, apply the constraint matrix and return the constrained</span>
<span class="sd">            system, otherwise simply return the constraint matrix. The default</span>
<span class="sd">            is True.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        np.ndarray or System</span>
<span class="sd">            Returns a System object with the constraints applied if</span>
<span class="sd">            `return_constrained_system` is True, otherwise just return the</span>
<span class="sd">            constraint matrix.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">shape_matrix_0</span> <span class="o">=</span> <span class="n">constraint_shapes</span><span class="p">[</span><span class="n">connection_dofs_0</span><span class="p">]</span><span class="o">.</span><span class="n">T</span>
        <span class="n">transform_matrix_0</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">transformation_matrix_at_coordinates</span><span class="p">(</span><span class="n">connection_dofs_0</span><span class="p">)</span>
        <span class="n">constraint_matrix</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">lstsq</span><span class="p">(</span><span class="n">shape_matrix_0</span><span class="p">,</span> <span class="n">transform_matrix_0</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">connection_dofs_1</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">shape_matrix_1</span> <span class="o">=</span> <span class="n">constraint_shapes</span><span class="p">[</span><span class="n">connection_dofs_1</span><span class="p">]</span><span class="o">.</span><span class="n">T</span>
            <span class="n">transform_matrix_1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">transformation_matrix_at_coordinates</span><span class="p">(</span><span class="n">connection_dofs_1</span><span class="p">)</span>
            <span class="n">constraint_matrix</span> <span class="o">-=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">lstsq</span><span class="p">(</span><span class="n">shape_matrix_1</span><span class="p">,</span> <span class="n">transform_matrix_1</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">return_constrained_system</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">constrain</span><span class="p">(</span><span class="n">constraint_matrix</span><span class="p">,</span> <span class="n">rcond</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">constraint_matrix</span></div>

<div class="viewcode-block" id="System.substructure_shakers"><a class="viewcode-back" href="../../../_autosummary/sdynpy.core.sdynpy_system.System.html#sdynpy.core.sdynpy_system.System.substructure_shakers">[docs]</a>    <span class="k">def</span><span class="w"> </span><span class="nf">substructure_shakers</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">shakers</span><span class="p">,</span><span class="n">coordinates</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Uses substructuring to attach 4DoF Shaker Models to the Substructure</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        shakers : array of Shaker4DoF</span>
<span class="sd">            4-DoF electromechanical models of a shaker that are added to the</span>
<span class="sd">            System</span>
<span class="sd">        coordinates : CoordinateArray</span>
<span class="sd">            The degrees of freedom at which the shakers should be attached.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        System</span>
<span class="sd">            A system with shakers attached to it.  The shaker degrees of freedom</span>
<span class="sd">            will be assigned based on the next power of 10 bigger than the</span>
<span class="sd">            current maximum node number.  Degrees of freedom end in 1 for</span>
<span class="sd">            armature force/displacement, 2 for body force/displacement, 3 for</span>
<span class="sd">            force gauge force/displacement, and 4 for drive voltage/current</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">constraint_pairs</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">shaker_systems</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="n">max_node</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">coordinate</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
        <span class="n">shaker_node_offset</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="mi">10</span><span class="o">**</span><span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">max_node</span><span class="p">)))</span>
        <span class="k">if</span> <span class="n">shaker_node_offset</span> <span class="o">==</span> <span class="n">max_node</span><span class="p">:</span>
            <span class="n">shaker_node_offset</span> <span class="o">*=</span> <span class="mi">10</span>
        <span class="k">if</span> <span class="n">shaker_node_offset</span> <span class="o">&lt;</span> <span class="mi">100</span><span class="p">:</span>
            <span class="n">shaker_node_offset</span> <span class="o">=</span> <span class="mi">100</span>

        <span class="k">for</span> <span class="n">i</span><span class="p">,(</span><span class="n">direction</span><span class="p">,</span><span class="n">shaker</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">coordinates</span><span class="p">,</span><span class="n">shakers</span><span class="p">)):</span>
            <span class="n">M</span><span class="p">,</span><span class="n">C</span><span class="p">,</span><span class="n">K</span> <span class="o">=</span> <span class="n">shaker</span><span class="o">.</span><span class="n">MCK</span><span class="p">()</span>
            <span class="n">coords</span> <span class="o">=</span> <span class="n">coordinate_array</span><span class="p">(</span><span class="n">shaker_node_offset</span> <span class="o">+</span> <span class="n">i</span><span class="o">*</span><span class="mi">10</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">,[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">shaker_systems</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">System</span><span class="p">(</span><span class="n">coords</span><span class="p">,</span><span class="n">M</span><span class="p">,</span><span class="n">K</span><span class="p">,</span><span class="n">C</span><span class="p">,</span><span class="n">enforce_symmetry</span> <span class="o">=</span> <span class="kc">False</span><span class="p">))</span>
            <span class="n">constraint_dof</span> <span class="o">=</span> <span class="n">coordinate_array</span><span class="p">(</span><span class="n">shaker_node_offset</span> <span class="o">+</span> <span class="n">i</span><span class="o">*</span><span class="mi">10</span> <span class="o">+</span> <span class="mi">3</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">constraint_pairs</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">direction</span><span class="p">,</span><span class="n">constraint_dof</span><span class="p">])</span>

        <span class="n">constraint_pairs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">constraint_pairs</span><span class="p">)</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="n">CoordinateArray</span><span class="p">)</span>

        <span class="n">combined_system</span> <span class="o">=</span> <span class="n">System</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="bp">self</span><span class="p">]</span><span class="o">+</span><span class="n">shaker_systems</span><span class="p">)</span>

        <span class="n">constrained_system</span> <span class="o">=</span> <span class="n">combined_system</span><span class="o">.</span><span class="n">substructure_by_coordinate</span><span class="p">(</span><span class="n">constraint_pairs</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">constrained_system</span></div>

<div class="viewcode-block" id="System.copy"><a class="viewcode-back" href="../../../_autosummary/sdynpy.core.sdynpy_system.System.html#sdynpy.core.sdynpy_system.System.copy">[docs]</a>    <span class="k">def</span><span class="w"> </span><span class="nf">copy</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns a copy of the system object</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        System</span>
<span class="sd">            A copy of the system object</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">System</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">coordinate</span><span class="o">.</span><span class="n">copy</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">mass</span><span class="o">.</span><span class="n">copy</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">stiffness</span><span class="o">.</span><span class="n">copy</span><span class="p">(),</span>
                      <span class="bp">self</span><span class="o">.</span><span class="n">damping</span><span class="o">.</span><span class="n">copy</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">transformation</span><span class="o">.</span><span class="n">copy</span><span class="p">(),</span>
                      <span class="bp">self</span><span class="o">.</span><span class="n">_enforce_symmetry</span><span class="p">)</span></div>

<div class="viewcode-block" id="System.set_proportional_damping"><a class="viewcode-back" href="../../../_autosummary/sdynpy.core.sdynpy_system.System.html#sdynpy.core.sdynpy_system.System.set_proportional_damping">[docs]</a>    <span class="k">def</span><span class="w"> </span><span class="nf">set_proportional_damping</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mass_fraction</span><span class="p">,</span> <span class="n">stiffness_fraction</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Sets the damping matrix to a proportion of the mass and stiffness matrices.</span>

<span class="sd">        The damping matrix will be set to `mass_fraction*self.mass +</span>
<span class="sd">        stiffness_fraction*self.stiffness`</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        mass_fraction : float</span>
<span class="sd">            Fraction of the mass matrix</span>
<span class="sd">        stiffness_fraction : TYPE</span>
<span class="sd">            Fraction of the stiffness matrix</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        None.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">damping</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mass</span> <span class="o">*</span> <span class="n">mass_fraction</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">stiffness</span> <span class="o">*</span> <span class="n">stiffness_fraction</span></div>

<div class="viewcode-block" id="System.beam"><a class="viewcode-back" href="../../../_autosummary/sdynpy.core.sdynpy_system.System.html#sdynpy.core.sdynpy_system.System.beam">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">beam</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">length</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span> <span class="n">height</span><span class="p">,</span> <span class="n">num_nodes</span><span class="p">,</span> <span class="n">E</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">rho</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">nu</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">material</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Create a beam mass and stiffness matrix</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        length : float</span>
<span class="sd">            Lenghth of the beam</span>
<span class="sd">        width : float</span>
<span class="sd">            Width of the beam</span>
<span class="sd">        height : float</span>
<span class="sd">            Height of the beam</span>
<span class="sd">        num_nodes : int</span>
<span class="sd">            Number of nodes in the beam.</span>
<span class="sd">        E : float, optional</span>
<span class="sd">            Young&#39;s modulus of the beam. If not specified, a `material` must be</span>
<span class="sd">            specified instead</span>
<span class="sd">        rho : float, optional</span>
<span class="sd">            Density of the beam. If not specified, a `material` must be</span>
<span class="sd">            specified instead</span>
<span class="sd">        nu : float, optional</span>
<span class="sd">            Poisson&#39;s ratio of the beam. If not specified, a `material` must be</span>
<span class="sd">            specified instead</span>
<span class="sd">        material : str, optional</span>
<span class="sd">            A specific material can be specified instead of `E`, `rho`, and `nu`.</span>
<span class="sd">            Should be a string &#39;steel&#39; or &#39;aluminum&#39;.  If not specified, then</span>
<span class="sd">            options `E`, `rho`, and `nu` must be specified instead.</span>

<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">        ValueError</span>
<span class="sd">            If improper materials are defined.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        system : System</span>
<span class="sd">            A system object consisting of the beam mass and stiffness matrices.</span>
<span class="sd">        geometry : Geometry</span>
<span class="sd">            A Geometry consisting of the beam geometry.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">from</span><span class="w"> </span><span class="nn">.sdynpy_geometry</span><span class="w"> </span><span class="kn">import</span> <span class="n">Geometry</span><span class="p">,</span> <span class="n">node_array</span><span class="p">,</span> <span class="n">traceline_array</span><span class="p">,</span> <span class="n">coordinate_system_array</span>
        <span class="n">node_positions</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">length</span><span class="p">,</span> <span class="n">num_nodes</span><span class="p">),</span>
                                   <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">num_nodes</span><span class="p">),</span>
                                   <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">num_nodes</span><span class="p">)))</span><span class="o">.</span><span class="n">T</span>
        <span class="n">node_connectivity</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">num_nodes</span> <span class="o">-</span> <span class="mi">1</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">num_nodes</span><span class="p">)))</span><span class="o">.</span><span class="n">T</span>
        <span class="n">bend_direction_1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">num_nodes</span> <span class="o">-</span> <span class="mi">1</span><span class="p">),</span>
                                     <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">num_nodes</span> <span class="o">-</span> <span class="mi">1</span><span class="p">),</span>
                                     <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">num_nodes</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)))</span><span class="o">.</span><span class="n">T</span>
        <span class="k">if</span> <span class="n">material</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">E</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">rho</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">nu</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Must specify material or E, nu, and rho&#39;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">material</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;steel&#39;</span><span class="p">:</span>
            <span class="n">E</span> <span class="o">=</span> <span class="mf">200e9</span>  <span class="c1"># [N/m^2],</span>
            <span class="n">nu</span> <span class="o">=</span> <span class="mf">0.25</span>  <span class="c1"># [-],</span>
            <span class="n">rho</span> <span class="o">=</span> <span class="mi">7850</span>  <span class="c1"># [kg/m^3]</span>
        <span class="k">elif</span> <span class="n">material</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;aluminum&#39;</span><span class="p">:</span>
            <span class="n">E</span> <span class="o">=</span> <span class="mf">69e9</span>  <span class="c1"># [N/m^2],</span>
            <span class="n">nu</span> <span class="o">=</span> <span class="mf">0.33</span>  <span class="c1"># [-],</span>
            <span class="n">rho</span> <span class="o">=</span> <span class="mi">2830</span>  <span class="c1"># [kg/m^3]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Unknown Material </span><span class="si">{:}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">material</span><span class="p">))</span>
        <span class="n">mat_props</span> <span class="o">=</span> <span class="n">rect_beam_props</span><span class="p">(</span><span class="n">E</span><span class="p">,</span> <span class="n">rho</span><span class="p">,</span> <span class="n">nu</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span> <span class="n">height</span><span class="p">,</span> <span class="n">num_nodes</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">K</span><span class="p">,</span> <span class="n">M</span> <span class="o">=</span> <span class="n">beamkm</span><span class="p">(</span><span class="n">node_positions</span><span class="p">,</span> <span class="n">node_connectivity</span><span class="p">,</span> <span class="n">bend_direction_1</span><span class="p">,</span> <span class="o">**</span><span class="n">mat_props</span><span class="p">)</span>
        <span class="n">coordinates</span> <span class="o">=</span> <span class="n">from_nodelist</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">num_nodes</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">directions</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">6</span><span class="p">])</span>
        <span class="n">system</span> <span class="o">=</span> <span class="bp">cls</span><span class="p">(</span><span class="n">coordinates</span><span class="p">,</span> <span class="n">M</span><span class="p">,</span> <span class="n">K</span><span class="p">)</span>
        <span class="n">nodelist</span> <span class="o">=</span> <span class="n">node_array</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">num_nodes</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">node_positions</span><span class="p">)</span>
        <span class="n">tracelines</span> <span class="o">=</span> <span class="n">traceline_array</span><span class="p">(</span><span class="n">connectivity</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">num_nodes</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">coordinate_systems</span> <span class="o">=</span> <span class="n">coordinate_system_array</span><span class="p">()</span>
        <span class="n">geometry</span> <span class="o">=</span> <span class="n">Geometry</span><span class="p">(</span><span class="n">nodelist</span><span class="p">,</span> <span class="n">coordinate_systems</span><span class="p">,</span> <span class="n">tracelines</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">system</span><span class="p">,</span> <span class="n">geometry</span></div>

<div class="viewcode-block" id="System.get_indices_by_coordinate"><a class="viewcode-back" href="../../../_autosummary/sdynpy.core.sdynpy_system.System.html#sdynpy.core.sdynpy_system.System.get_indices_by_coordinate">[docs]</a>    <span class="k">def</span><span class="w"> </span><span class="nf">get_indices_by_coordinate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">coordinates</span><span class="p">,</span> <span class="n">ignore_sign</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Gets the indices in the transformation matrix corresponding coordinates</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        coordinates : CoordinateArray</span>
<span class="sd">            Coordinates to extract transformation indices</span>
<span class="sd">        ignore_sign : bool, optional</span>
<span class="sd">            Specify whether or not to ignore signs on the coordinates.  If True,</span>
<span class="sd">            then &#39;101X+&#39; would match &#39;101X+&#39; or &#39;101X-&#39;. The default is False.</span>

<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">        ValueError</span>
<span class="sd">            Raised if duplicate coordinates or coordinates not in the system</span>
<span class="sd">            are requested</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        np.ndarray</span>
<span class="sd">            Array of indices.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">ignore_sign</span><span class="p">:</span>
            <span class="n">consistent_arrays</span><span class="p">,</span> <span class="n">shape_indices</span><span class="p">,</span> <span class="n">request_indices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">intersect1d</span><span class="p">(</span>
                <span class="nb">abs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">coordinate</span><span class="p">),</span> <span class="nb">abs</span><span class="p">(</span><span class="n">coordinates</span><span class="p">),</span> <span class="n">assume_unique</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">return_indices</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">consistent_arrays</span><span class="p">,</span> <span class="n">shape_indices</span><span class="p">,</span> <span class="n">request_indices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">intersect1d</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">coordinate</span><span class="p">,</span> <span class="n">coordinates</span><span class="p">,</span> <span class="n">assume_unique</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">return_indices</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="c1"># Make sure that all of the keys are actually in the consistent array matrix</span>
        <span class="k">if</span> <span class="n">consistent_arrays</span><span class="o">.</span><span class="n">size</span> <span class="o">!=</span> <span class="n">coordinates</span><span class="o">.</span><span class="n">size</span><span class="p">:</span>
            <span class="n">extra_keys</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">setdiff1d</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">coordinates</span><span class="p">),</span> <span class="nb">abs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">coordinate</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">extra_keys</span><span class="o">.</span><span class="n">size</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="s1">&#39;Duplicate coordinate values requested.  Please ensure coordinate indices are unique.&#39;</span><span class="p">)</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s1">&#39;Not all indices in requested coordinate array exist in the system</span><span class="se">\n</span><span class="si">{:}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">extra_keys</span><span class="p">)))</span>
        <span class="c1"># Handle sign flipping</span>
        <span class="n">return_value</span> <span class="o">=</span> <span class="n">shape_indices</span>
        <span class="c1"># Invert the indices to return the dofs in the correct order as specified in keys</span>
        <span class="n">inverse_indices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">request_indices</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
        <span class="n">inverse_indices</span><span class="p">[</span><span class="n">request_indices</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">request_indices</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">return_value</span><span class="p">[</span><span class="n">inverse_indices</span><span class="p">]</span></div>

<div class="viewcode-block" id="System.reduce"><a class="viewcode-back" href="../../../_autosummary/sdynpy.core.sdynpy_system.System.html#sdynpy.core.sdynpy_system.System.reduce">[docs]</a>    <span class="k">def</span><span class="w"> </span><span class="nf">reduce</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">reduction_transformation</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Apply the specified reduction to the model</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        reduction_transformation : np.ndarray</span>
<span class="sd">            Matrix to use in the reduction</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        System</span>
<span class="sd">            Reduced system.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">mass</span> <span class="o">=</span> <span class="n">reduction_transformation</span><span class="o">.</span><span class="n">T</span> <span class="o">@</span> <span class="bp">self</span><span class="o">.</span><span class="n">mass</span> <span class="o">@</span> <span class="n">reduction_transformation</span>
        <span class="n">stiffness</span> <span class="o">=</span> <span class="n">reduction_transformation</span><span class="o">.</span><span class="n">T</span> <span class="o">@</span> <span class="bp">self</span><span class="o">.</span><span class="n">stiffness</span> <span class="o">@</span> <span class="n">reduction_transformation</span>
        <span class="n">damping</span> <span class="o">=</span> <span class="n">reduction_transformation</span><span class="o">.</span><span class="n">T</span> <span class="o">@</span> <span class="bp">self</span><span class="o">.</span><span class="n">damping</span> <span class="o">@</span> <span class="n">reduction_transformation</span>
        <span class="n">transformation</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">transformation</span> <span class="o">@</span> <span class="n">reduction_transformation</span>
        <span class="c1"># Force symmetry</span>
        <span class="n">mass</span> <span class="o">=</span> <span class="p">(</span><span class="n">mass</span> <span class="o">+</span> <span class="n">mass</span><span class="o">.</span><span class="n">T</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span>
        <span class="n">stiffness</span> <span class="o">=</span> <span class="p">(</span><span class="n">stiffness</span> <span class="o">+</span> <span class="n">stiffness</span><span class="o">.</span><span class="n">T</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span>
        <span class="n">damping</span> <span class="o">=</span> <span class="p">(</span><span class="n">damping</span> <span class="o">+</span> <span class="n">damping</span><span class="o">.</span><span class="n">T</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span>
        <span class="k">return</span> <span class="n">System</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">coordinate</span><span class="p">,</span> <span class="n">mass</span><span class="p">,</span> <span class="n">stiffness</span><span class="p">,</span> <span class="n">damping</span><span class="p">,</span> <span class="n">transformation</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_enforce_symmetry</span><span class="p">)</span></div>

<div class="viewcode-block" id="System.reduce_guyan"><a class="viewcode-back" href="../../../_autosummary/sdynpy.core.sdynpy_system.System.html#sdynpy.core.sdynpy_system.System.reduce_guyan">[docs]</a>    <span class="k">def</span><span class="w"> </span><span class="nf">reduce_guyan</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">coordinates</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Perform Guyan reduction on the system</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        coordinates : CoordinateArray</span>
<span class="sd">            A list of coordinates to keep in the reduced system.</span>

<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">        ValueError</span>
<span class="sd">            Raised the transformation matrix is not identity matrix.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        System</span>
<span class="sd">            Reduced system.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">coordinates</span><span class="p">,</span> <span class="n">CoordinateArray</span><span class="p">):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">transformation</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">transformation</span><span class="o">.</span><span class="n">shape</span><span class="p">)):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="s1">&#39;Coordinates can only be specified with a CoordinateArray if the transformation is identity&#39;</span><span class="p">)</span>
            <span class="n">keep_dofs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_indices_by_coordinate</span><span class="p">(</span><span class="n">coordinates</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">keep_dofs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">coordinates</span><span class="p">)</span>
        <span class="n">discard_dofs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ndof</span><span class="p">)</span> <span class="k">if</span> <span class="n">i</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">keep_dofs</span><span class="p">])</span>
        <span class="n">I_a</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="n">keep_dofs</span><span class="o">.</span><span class="n">size</span><span class="p">)</span>
        <span class="n">K_dd</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stiffness</span><span class="p">[</span><span class="n">discard_dofs</span><span class="p">[:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">],</span>
                              <span class="n">discard_dofs</span><span class="p">]</span>
        <span class="n">K_da</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stiffness</span><span class="p">[</span><span class="n">discard_dofs</span><span class="p">[:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">],</span>
                              <span class="n">keep_dofs</span><span class="p">]</span>
        <span class="n">T_guyan</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">I_a</span><span class="p">,</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span><span class="n">K_dd</span><span class="p">,</span> <span class="n">K_da</span><span class="p">)),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">T_guyan</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">keep_dofs</span><span class="p">,</span> <span class="n">discard_dofs</span><span class="p">)),</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">T_guyan</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">reduce</span><span class="p">(</span><span class="n">T_guyan</span><span class="p">)</span></div>

<div class="viewcode-block" id="System.reduce_dynamic"><a class="viewcode-back" href="../../../_autosummary/sdynpy.core.sdynpy_system.System.html#sdynpy.core.sdynpy_system.System.reduce_dynamic">[docs]</a>    <span class="k">def</span><span class="w"> </span><span class="nf">reduce_dynamic</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">coordinates</span><span class="p">,</span> <span class="n">frequency</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Perform Dynamic condensation</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        coordinates : CoordinateArray</span>
<span class="sd">            A list of coordinates to keep in the reduced system.</span>
<span class="sd">        frequency : float</span>
<span class="sd">            The frequency to preserve in the dynamic reduction.</span>

<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">        ValueError</span>
<span class="sd">            Raised if the transformation is not identity matrix.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        System</span>
<span class="sd">            Reduced system.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">coordinates</span><span class="p">,</span> <span class="n">CoordinateArray</span><span class="p">):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">transformation</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">transformation</span><span class="o">.</span><span class="n">shape</span><span class="p">)):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="s1">&#39;Coordinates can only be specified with a CoordinateArray if the transformation is identity&#39;</span><span class="p">)</span>
            <span class="n">keep_dofs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_indices_by_coordinate</span><span class="p">(</span><span class="n">coordinates</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">keep_dofs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">coordinates</span><span class="p">)</span>
        <span class="n">discard_dofs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ndof</span><span class="p">)</span> <span class="k">if</span> <span class="n">i</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">keep_dofs</span><span class="p">])</span>
        <span class="n">I_a</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="n">keep_dofs</span><span class="o">.</span><span class="n">size</span><span class="p">)</span>
        <span class="n">D</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stiffness</span> <span class="o">-</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">frequency</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">mass</span>
        <span class="n">D_dd</span> <span class="o">=</span> <span class="n">D</span><span class="p">[</span><span class="n">discard_dofs</span><span class="p">[:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">],</span>
                 <span class="n">discard_dofs</span><span class="p">]</span>
        <span class="n">D_da</span> <span class="o">=</span> <span class="n">D</span><span class="p">[</span><span class="n">discard_dofs</span><span class="p">[:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">],</span>
                 <span class="n">keep_dofs</span><span class="p">]</span>
        <span class="n">T_dynamic</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">I_a</span><span class="p">,</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span><span class="n">D_dd</span><span class="p">,</span> <span class="n">D_da</span><span class="p">)),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">T_dynamic</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">keep_dofs</span><span class="p">,</span> <span class="n">discard_dofs</span><span class="p">)),</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">T_dynamic</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">reduce</span><span class="p">(</span><span class="n">T_dynamic</span><span class="p">)</span></div>

<div class="viewcode-block" id="System.reduce_craig_bampton"><a class="viewcode-back" href="../../../_autosummary/sdynpy.core.sdynpy_system.System.html#sdynpy.core.sdynpy_system.System.reduce_craig_bampton">[docs]</a>    <span class="k">def</span><span class="w"> </span><span class="nf">reduce_craig_bampton</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">connection_degrees_of_freedom</span><span class="p">:</span> <span class="n">CoordinateArray</span><span class="p">,</span>
                             <span class="n">num_fixed_base_modes</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
                             <span class="n">return_shape_matrix</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Computes a craig-bampton substructure model for the system</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        connection_degrees_of_freedom : CoordinateArray</span>
<span class="sd">            Degrees of freedom to keep at the interface.</span>
<span class="sd">        num_fixed_base_modes : int</span>
<span class="sd">            Number of fixed-base modes to use in the reduction</span>
<span class="sd">        return_shape_matrix : bool, optional</span>
<span class="sd">            If true, return a set of shapes that represents the transformation</span>
<span class="sd">            in addition to the reduced system.  The default is False.</span>

<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">        ValueError</span>
<span class="sd">            Raised if coordinate arrays are specified when there is already a</span>
<span class="sd">            transformation.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        System</span>
<span class="sd">            Reduced system in craig-bampton form</span>
<span class="sd">        ShapeArray</span>
<span class="sd">            Shapes representing the craig-bampton transformation</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Construct craig bampton transformation</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">connection_degrees_of_freedom</span><span class="p">,</span> <span class="n">CoordinateArray</span><span class="p">):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">transformation</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">transformation</span><span class="o">.</span><span class="n">shape</span><span class="p">)):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="s1">&#39;Coordinates can only be specified with a CoordinateArray if the transformation is identity&#39;</span><span class="p">)</span>
            <span class="n">connection_indices</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_indices_by_coordinate</span><span class="p">(</span><span class="n">connection_degrees_of_freedom</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">connection_indices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">connection_degrees_of_freedom</span><span class="p">)</span>
        <span class="n">other_indices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ndof</span><span class="p">)</span> <span class="k">if</span> <span class="n">i</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">connection_indices</span><span class="p">])</span>

        <span class="c1"># Extract portions of the mass and stiffness matrices</span>
        <span class="n">K_ii</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">K</span><span class="p">[</span><span class="n">other_indices</span><span class="p">[:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">],</span> <span class="n">other_indices</span><span class="p">]</span>
        <span class="n">M_ii</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">M</span><span class="p">[</span><span class="n">other_indices</span><span class="p">[:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">],</span> <span class="n">other_indices</span><span class="p">]</span>
        <span class="n">K_ib</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">K</span><span class="p">[</span><span class="n">other_indices</span><span class="p">[:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">],</span> <span class="n">connection_indices</span><span class="p">]</span>

        <span class="c1"># Compute fixed interface modes</span>
        <span class="n">lam</span><span class="p">,</span> <span class="n">Phi_ii</span> <span class="o">=</span> <span class="n">eigh</span><span class="p">(</span><span class="n">K_ii</span><span class="p">,</span> <span class="n">M_ii</span><span class="p">,</span> <span class="n">subset_by_index</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">num_fixed_base_modes</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">])</span>
        <span class="c1"># Normalize the mode shapes</span>
        <span class="n">lam</span><span class="p">[</span><span class="n">lam</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">normalized_mass</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">Phi_ii</span><span class="o">.</span><span class="n">T</span> <span class="o">@</span> <span class="n">M_ii</span> <span class="o">@</span> <span class="n">Phi_ii</span><span class="p">)</span>
        <span class="n">Phi_ii</span> <span class="o">/=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">normalized_mass</span><span class="p">)</span>
        <span class="n">Z_bi</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">connection_indices</span><span class="o">.</span><span class="n">size</span><span class="p">,</span> <span class="n">num_fixed_base_modes</span><span class="p">))</span>
        <span class="c1"># Compute constraint modes</span>
        <span class="n">Psi_ib</span> <span class="o">=</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span><span class="n">K_ii</span><span class="p">,</span> <span class="n">K_ib</span><span class="p">)</span>
        <span class="n">I_bb</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="n">connection_indices</span><span class="o">.</span><span class="n">size</span><span class="p">)</span>
        <span class="n">T_cb</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">block</span><span class="p">([[</span><span class="n">Phi_ii</span><span class="p">,</span> <span class="n">Psi_ib</span><span class="p">],</span>
                         <span class="p">[</span><span class="n">Z_bi</span><span class="p">,</span> <span class="n">I_bb</span><span class="p">]])</span>
        <span class="n">T_cb</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">other_indices</span><span class="p">,</span> <span class="n">connection_indices</span><span class="p">)),</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">T_cb</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">return_shape_matrix</span><span class="p">:</span>
            <span class="kn">from</span><span class="w"> </span><span class="nn">.sdynpy_shape</span><span class="w"> </span><span class="kn">import</span> <span class="n">shape_array</span>
            <span class="n">freq</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">lam</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span>
            <span class="n">all_freqs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">freq</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">connection_indices</span><span class="o">.</span><span class="n">size</span><span class="p">)))</span>
            <span class="n">shapes</span> <span class="o">=</span> <span class="n">shape_array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">coordinate</span><span class="p">,</span> <span class="n">T_cb</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">all_freqs</span><span class="p">,</span> <span class="n">comment1</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;Fixed Base Mode </span><span class="si">{:}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_fixed_base_modes</span><span class="p">)]</span> <span class="o">+</span> <span class="p">[</span><span class="s1">&#39;Constraint Mode </span><span class="si">{:}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">dof</span><span class="p">))</span> <span class="k">for</span> <span class="n">dof</span> <span class="ow">in</span> <span class="n">connection_degrees_of_freedom</span><span class="p">])</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">reduce</span><span class="p">(</span><span class="n">T_cb</span><span class="p">),</span> <span class="n">shapes</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">reduce</span><span class="p">(</span><span class="n">T_cb</span><span class="p">)</span></div>

<div class="viewcode-block" id="System.from_exodus_superelement"><a class="viewcode-back" href="../../../_autosummary/sdynpy.core.sdynpy_system.System.html#sdynpy.core.sdynpy_system.System.from_exodus_superelement">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">from_exodus_superelement</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">superelement_nc4</span><span class="p">,</span> <span class="n">transformation_exodus_file</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                 <span class="n">x_disp</span><span class="o">=</span><span class="s1">&#39;DispX&#39;</span><span class="p">,</span> <span class="n">y_disp</span><span class="o">=</span><span class="s1">&#39;DispY&#39;</span><span class="p">,</span> <span class="n">z_disp</span><span class="o">=</span><span class="s1">&#39;DispZ&#39;</span><span class="p">,</span>
                                 <span class="n">x_rot</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">y_rot</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">z_rot</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                 <span class="n">reduce_to_external_surfaces</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Creates a system from a superelement from Sierra/SD</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        superelement_nc4 : netCDF4.Dataset or string</span>
<span class="sd">            Dataset from which the superelement data will be loaded</span>
<span class="sd">        transformation_exodus_file : Exodus, ExodusInMemory, or str, optional</span>
<span class="sd">            Exodus data containing the transformation between the reduced</span>
<span class="sd">            superelement state and the physical space.  If not specified, no</span>
<span class="sd">            transformation will be created.</span>
<span class="sd">        x_disp : str, optional</span>
<span class="sd">            Variable name to read for x-displacements in the transformation</span>
<span class="sd">            Exodus file. The default is &#39;DispX&#39;.</span>
<span class="sd">        y_disp : str, optional</span>
<span class="sd">            Variable name to read for y-displacements in the transformation</span>
<span class="sd">            Exodus file. The default is &#39;DispY&#39;.</span>
<span class="sd">        z_disp : str, optional</span>
<span class="sd">            Variable name to read for z-displacements in the transformation</span>
<span class="sd">            Exodus file. The default is &#39;DispZ&#39;.</span>
<span class="sd">        x_rot : str, optional</span>
<span class="sd">            Variable name to read for x-rotations in the transformation</span>
<span class="sd">            Exodus file. The default is to not read rotations.</span>
<span class="sd">        y_rot : str, optional</span>
<span class="sd">            Variable name to read for y-rotations in the transformation</span>
<span class="sd">            Exodus file. The default is to not read rotations.</span>
<span class="sd">        z_rot : str, optional</span>
<span class="sd">            Variable name to read for z-rotations in the transformation</span>
<span class="sd">            Exodus file. The default is to not read rotations.</span>
<span class="sd">        reduce_to_external_surfaces : bool, optional</span>
<span class="sd">            If True, exodus results will be reduced to external surfaces</span>

<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">        ValueError</span>
<span class="sd">            raised if bad data types are passed to the arguments.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        system : System</span>
<span class="sd">            System containing the superelement representation</span>
<span class="sd">        geometry : Geometry</span>
<span class="sd">            Geometry that can be used to plot the system</span>
<span class="sd">        boundary_dofs : CoordinateArray</span>
<span class="sd">            Degrees of freedom that can be used to constrain the test article.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">from</span><span class="w"> </span><span class="nn">.sdynpy_geometry</span><span class="w"> </span><span class="kn">import</span> <span class="n">node_array</span><span class="p">,</span> <span class="n">coordinate_system_array</span><span class="p">,</span> <span class="n">Geometry</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">superelement_nc4</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">ds</span> <span class="o">=</span> <span class="n">nc4</span><span class="o">.</span><span class="n">Dataset</span><span class="p">(</span><span class="n">superelement_nc4</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">superelement_nc4</span><span class="p">,</span> <span class="n">nc4</span><span class="o">.</span><span class="n">Dataset</span><span class="p">):</span>
            <span class="n">ds</span> <span class="o">=</span> <span class="n">superelement_nc4</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;superelement_nc4 must be a string or a netCDF4 Dataset&#39;</span><span class="p">)</span>
        <span class="n">cbmap</span> <span class="o">=</span> <span class="n">ds</span><span class="p">[</span><span class="s1">&#39;cbmap&#39;</span><span class="p">][:]</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">Kr</span> <span class="o">=</span> <span class="n">ds</span><span class="p">[</span><span class="s1">&#39;Kr&#39;</span><span class="p">][:]</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">Mr</span> <span class="o">=</span> <span class="n">ds</span><span class="p">[</span><span class="s1">&#39;Mr&#39;</span><span class="p">][:]</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">Cr</span> <span class="o">=</span> <span class="n">ds</span><span class="p">[</span><span class="s1">&#39;Cr&#39;</span><span class="p">][:]</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">num_constraint_modes</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">dimensions</span><span class="p">[</span><span class="s1">&#39;NumConstraints&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">size</span>
        <span class="n">num_fixed_base_modes</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">dimensions</span><span class="p">[</span><span class="s1">&#39;NumEig&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">size</span>
        <span class="n">boundary_dofs</span> <span class="o">=</span> <span class="n">coordinate_array</span><span class="p">(</span><span class="o">*</span><span class="n">cbmap</span><span class="p">[</span><span class="n">cbmap</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">transformation_exodus_file</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">transformation</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">coordinate_nodes</span> <span class="o">=</span> <span class="n">cbmap</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span>
            <span class="n">coordinate_dirs</span> <span class="o">=</span> <span class="n">cbmap</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span>
            <span class="n">coordinate_nodes</span><span class="p">[</span><span class="n">coordinate_nodes</span> <span class="o">==</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">num_fixed_base_modes</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
            <span class="n">coordinates</span> <span class="o">=</span> <span class="n">coordinate_array</span><span class="p">(</span><span class="n">coordinate_nodes</span><span class="p">,</span> <span class="n">coordinate_dirs</span><span class="p">)</span>
            <span class="n">cs_array</span> <span class="o">=</span> <span class="n">coordinate_system_array</span><span class="p">()</span>
            <span class="n">n_array</span> <span class="o">=</span> <span class="n">node_array</span><span class="p">(</span><span class="n">ds</span><span class="p">[</span><span class="s1">&#39;node_num_map&#39;</span><span class="p">][:],</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
                <span class="p">[</span><span class="n">ds</span><span class="p">[</span><span class="s1">&#39;coord</span><span class="si">{:}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">d</span><span class="p">)][:]</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="s1">&#39;xyz&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>
            <span class="n">geometry</span> <span class="o">=</span> <span class="n">Geometry</span><span class="p">(</span><span class="n">node</span><span class="o">=</span><span class="n">n_array</span><span class="p">,</span> <span class="n">coordinate_system</span><span class="o">=</span><span class="n">cs_array</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">transformation_exodus_file</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                <span class="n">exo</span> <span class="o">=</span> <span class="n">Exodus</span><span class="p">(</span><span class="n">transformation_exodus_file</span><span class="p">)</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">transformation_exodus_file</span><span class="p">,</span> <span class="n">Exodus</span><span class="p">):</span>
                <span class="n">exo</span> <span class="o">=</span> <span class="n">transformation_exodus_file</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">transformation_exodus_file</span><span class="p">,</span> <span class="n">ExodusInMemory</span><span class="p">):</span>
                <span class="n">exo</span> <span class="o">=</span> <span class="n">transformation_exodus_file</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;transformation_exodus_file must be a string or a sdpy.Exodus&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">reduce_to_external_surfaces</span><span class="p">:</span>
                <span class="n">exo</span> <span class="o">=</span> <span class="n">reduce_exodus_to_surfaces</span><span class="p">(</span><span class="n">exo</span><span class="p">,</span> <span class="n">variables_to_transform</span><span class="o">=</span><span class="p">[</span><span class="n">var</span> <span class="k">for</span> <span class="n">var</span> <span class="ow">in</span> <span class="p">[</span><span class="n">x_disp</span><span class="p">,</span> <span class="n">y_disp</span><span class="p">,</span> <span class="n">z_disp</span><span class="p">,</span> <span class="n">x_rot</span><span class="p">,</span> <span class="n">y_rot</span><span class="p">,</span> <span class="n">z_rot</span><span class="p">]</span> <span class="k">if</span> <span class="n">var</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">])</span>
            <span class="kn">from</span><span class="w"> </span><span class="nn">.sdynpy_shape</span><span class="w"> </span><span class="kn">import</span> <span class="n">ShapeArray</span>
            <span class="n">shapes</span> <span class="o">=</span> <span class="n">ShapeArray</span><span class="o">.</span><span class="n">from_exodus</span><span class="p">(</span><span class="n">exo</span><span class="p">,</span> <span class="n">x_disp</span><span class="p">,</span> <span class="n">y_disp</span><span class="p">,</span> <span class="n">z_disp</span><span class="p">,</span> <span class="n">x_rot</span><span class="p">,</span> <span class="n">y_rot</span><span class="p">,</span> <span class="n">z_rot</span><span class="p">)</span>
            <span class="n">transformation</span> <span class="o">=</span> <span class="n">shapes</span><span class="o">.</span><span class="n">shape_matrix</span><span class="o">.</span><span class="n">T</span>
            <span class="n">coordinates</span> <span class="o">=</span> <span class="n">shapes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">coordinate</span>
            <span class="n">geometry</span> <span class="o">=</span> <span class="n">Geometry</span><span class="o">.</span><span class="n">from_exodus</span><span class="p">(</span><span class="n">exo</span><span class="p">)</span>
        <span class="n">system</span> <span class="o">=</span> <span class="bp">cls</span><span class="p">(</span><span class="n">coordinates</span><span class="p">,</span> <span class="n">Mr</span><span class="p">,</span> <span class="n">Kr</span><span class="p">,</span> <span class="n">Cr</span><span class="p">,</span> <span class="n">transformation</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">system</span><span class="p">,</span> <span class="n">geometry</span><span class="p">,</span> <span class="n">boundary_dofs</span></div>

<div class="viewcode-block" id="System.from_sierra_sd_mfile_output"><a class="viewcode-back" href="../../../_autosummary/sdynpy.core.sdynpy_system.System.html#sdynpy.core.sdynpy_system.System.from_sierra_sd_mfile_output">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">from_sierra_sd_mfile_output</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">maa_file</span><span class="p">,</span> <span class="n">kaa_file</span><span class="p">,</span> <span class="n">gid_file</span><span class="p">,</span> <span class="n">aset_map_file</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Generates a System object from the MFILE, MAA, and KAA outputs from</span>
<span class="sd">        Sierra/SD</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        maa_file : str</span>
<span class="sd">            Path to the file containing the MAA matrix.</span>
<span class="sd">        kaa_file : str</span>
<span class="sd">            Path to the file containing the KAA matrix.</span>
<span class="sd">        gid_file : str</span>
<span class="sd">            Path to the file contiaining the global node id map</span>
<span class="sd">        aset_map_file : str</span>
<span class="sd">            Path to the A-set Map.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        system : System</span>
<span class="sd">            A system object with the specified matrices and degrees of freedom.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">M</span> <span class="o">=</span> <span class="n">read_sierra_matlab_matrix_file</span><span class="p">(</span><span class="n">maa_file</span><span class="p">)</span>
        <span class="n">K</span> <span class="o">=</span> <span class="n">read_sierra_matlab_matrix_file</span><span class="p">(</span><span class="n">kaa_file</span><span class="p">)</span>
        <span class="n">gid</span> <span class="o">=</span> <span class="n">read_sierra_matlab_map_file</span><span class="p">(</span><span class="n">gid_file</span><span class="p">)</span>
        <span class="n">asetmap</span> <span class="o">=</span> <span class="n">read_sierra_matlab_map_file</span><span class="p">(</span><span class="n">aset_map_file</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">9</span><span class="p">)</span>
        <span class="n">valid_dofs</span> <span class="o">=</span> <span class="n">asetmap</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span>
        <span class="c1"># Check if any of the acoustic, temperature, or voltage are defined</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">valid_dofs</span><span class="p">[:,</span><span class="o">-</span><span class="mi">3</span><span class="p">:]):</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s1">&#39;Sierra system contains acoustic, temperature, or voltage degrees of freedom.  These will be ignored by SDynPy.&#39;</span><span class="p">)</span>
        <span class="n">valid_dofs</span> <span class="o">=</span> <span class="n">valid_dofs</span><span class="p">[:,:</span><span class="o">-</span><span class="mi">3</span><span class="p">]</span>
        <span class="n">asetmap</span> <span class="o">=</span> <span class="n">asetmap</span><span class="p">[:,:</span><span class="o">-</span><span class="mi">3</span><span class="p">]</span>
        <span class="n">coordinates</span> <span class="o">=</span> <span class="n">coordinate_array</span><span class="p">(</span><span class="n">gid</span><span class="p">[:,</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">],[</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">6</span><span class="p">])[</span><span class="n">valid_dofs</span><span class="p">]</span>
        <span class="n">dof_ordering</span> <span class="o">=</span> <span class="n">asetmap</span><span class="p">[</span><span class="n">valid_dofs</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span>
        <span class="n">M</span> <span class="o">=</span> <span class="n">M</span><span class="p">[</span><span class="n">dof_ordering</span><span class="p">[:,</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">],</span><span class="n">dof_ordering</span><span class="p">]</span>
        <span class="n">K</span> <span class="o">=</span> <span class="n">K</span><span class="p">[</span><span class="n">dof_ordering</span><span class="p">[:,</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">],</span><span class="n">dof_ordering</span><span class="p">]</span>
        <span class="n">system</span> <span class="o">=</span> <span class="bp">cls</span><span class="p">(</span><span class="n">coordinates</span><span class="p">,</span><span class="n">M</span><span class="p">,</span><span class="n">K</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">system</span></div>

<div class="viewcode-block" id="System.simulate_test"><a class="viewcode-back" href="../../../_autosummary/sdynpy.core.sdynpy_system.System.html#sdynpy.core.sdynpy_system.System.simulate_test">[docs]</a>    <span class="k">def</span><span class="w"> </span><span class="nf">simulate_test</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span>  <span class="c1"># The system itself</span>
            <span class="n">bandwidth</span><span class="p">,</span>
            <span class="n">frame_length</span><span class="p">,</span>
            <span class="n">num_averages</span><span class="p">,</span>
            <span class="n">excitation</span><span class="p">,</span>
            <span class="n">references</span><span class="p">,</span>
            <span class="n">responses</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>  <span class="c1"># All Responses</span>
            <span class="n">excitation_level</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span>
            <span class="n">excitation_noise_level</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span>
            <span class="n">response_noise_level</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span>
            <span class="n">steady_state_time</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span>
            <span class="n">excitation_min_frequency</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">excitation_max_frequency</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">signal_fraction</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span>
            <span class="n">extra_time_between_frames</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span>
            <span class="n">integration_oversample</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
            <span class="n">antialias_filter_cutoff_factor</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>
            <span class="n">antialias_filter_order</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span>
            <span class="n">multihammer_impact_spacing_factor</span> <span class="o">=</span> <span class="mi">4</span><span class="p">,</span>
            <span class="n">extra_outputs</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
            <span class="o">**</span><span class="n">generator_kwargs</span>
    <span class="p">):</span>
        <span class="n">available_excitations</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;pseudorandom&#39;</span><span class="p">,</span> <span class="s1">&#39;random&#39;</span><span class="p">,</span>
                                 <span class="s1">&#39;burst random&#39;</span><span class="p">,</span> <span class="s1">&#39;chirp&#39;</span><span class="p">,</span> <span class="s1">&#39;hammer&#39;</span><span class="p">,</span> <span class="s1">&#39;multi-hammer&#39;</span><span class="p">,</span> <span class="s1">&#39;sine&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">excitation</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="n">available_excitations</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Excitation must be one of </span><span class="si">{:}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">available_excitations</span><span class="p">))</span>
        <span class="c1"># Create the input signal</span>
        <span class="n">references</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">references</span><span class="p">)</span>
        <span class="n">num_signals</span> <span class="o">=</span> <span class="n">references</span><span class="o">.</span><span class="n">size</span>
        <span class="n">sample_rate</span> <span class="o">=</span> <span class="n">bandwidth</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">integration_oversample</span>
        <span class="n">dt</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">/</span> <span class="n">sample_rate</span>
        <span class="n">frame_time</span> <span class="o">=</span> <span class="n">dt</span> <span class="o">*</span> <span class="n">frame_length</span> <span class="o">*</span> <span class="n">integration_oversample</span>
        <span class="c1"># Create the signals</span>
        <span class="k">if</span> <span class="n">excitation</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;pseudorandom&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">num_signals</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Warning: Pseudorandom generally not recommended for multi-reference excitation.&#39;</span><span class="p">)</span>
            <span class="n">kwargs</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;fft_lines&#39;</span><span class="p">:</span> <span class="n">frame_length</span> <span class="o">//</span> <span class="mi">2</span><span class="p">,</span>
                      <span class="s1">&#39;f_nyq&#39;</span><span class="p">:</span> <span class="n">bandwidth</span><span class="p">,</span>
                      <span class="s1">&#39;signal_rms&#39;</span><span class="p">:</span> <span class="n">excitation_level</span><span class="p">,</span>
                      <span class="s1">&#39;min_freq&#39;</span><span class="p">:</span> <span class="n">excitation_min_frequency</span><span class="p">,</span>
                      <span class="s1">&#39;max_freq&#39;</span><span class="p">:</span> <span class="n">excitation_max_frequency</span><span class="p">,</span>
                      <span class="s1">&#39;integration_oversample&#39;</span><span class="p">:</span> <span class="n">integration_oversample</span><span class="p">,</span>
                      <span class="s1">&#39;averages&#39;</span><span class="p">:</span> <span class="n">num_averages</span> <span class="o">+</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">steady_state_time</span> <span class="o">/</span> <span class="n">frame_time</span><span class="p">))}</span>
            <span class="n">kwargs</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">generator_kwargs</span><span class="p">)</span>
            <span class="n">signals</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span>
                <span class="n">generator</span><span class="o">.</span><span class="n">pseudorandom</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_signals</span><span class="p">)</span>
            <span class="p">])</span>
        <span class="k">elif</span> <span class="n">excitation</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;random&#39;</span><span class="p">:</span>
            <span class="n">kwargs</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;shape&#39;</span><span class="p">:</span> <span class="p">(</span><span class="n">num_signals</span><span class="p">,),</span>
                      <span class="s1">&#39;n_samples&#39;</span><span class="p">:</span> <span class="n">frame_length</span> <span class="o">*</span> <span class="n">integration_oversample</span> <span class="o">*</span> <span class="n">num_averages</span> <span class="o">+</span> <span class="nb">int</span><span class="p">(</span><span class="n">steady_state_time</span> <span class="o">*</span> <span class="n">sample_rate</span><span class="p">),</span>
                      <span class="s1">&#39;rms&#39;</span><span class="p">:</span> <span class="n">excitation_level</span><span class="p">,</span>
                      <span class="s1">&#39;dt&#39;</span><span class="p">:</span> <span class="n">dt</span><span class="p">,</span>
                      <span class="s1">&#39;low_frequency_cutoff&#39;</span><span class="p">:</span> <span class="n">excitation_min_frequency</span><span class="p">,</span>
                      <span class="s1">&#39;high_frequency_cutoff&#39;</span><span class="p">:</span> <span class="n">bandwidth</span> <span class="k">if</span> <span class="n">excitation_max_frequency</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">excitation_max_frequency</span><span class="p">}</span>
            <span class="n">kwargs</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">generator_kwargs</span><span class="p">)</span>
            <span class="n">signals</span> <span class="o">=</span> <span class="n">generator</span><span class="o">.</span><span class="n">random</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">excitation</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;burst random&#39;</span><span class="p">:</span>
            <span class="n">kwargs</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;shape&#39;</span><span class="p">:</span> <span class="p">(</span><span class="n">num_signals</span><span class="p">,),</span>
                      <span class="s1">&#39;n_samples&#39;</span><span class="p">:</span> <span class="n">frame_length</span> <span class="o">*</span> <span class="n">integration_oversample</span><span class="p">,</span>
                      <span class="s1">&#39;on_fraction&#39;</span><span class="p">:</span> <span class="n">signal_fraction</span><span class="p">,</span>
                      <span class="s1">&#39;delay_fraction&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
                      <span class="s1">&#39;rms&#39;</span><span class="p">:</span> <span class="n">excitation_level</span><span class="p">,</span>
                      <span class="s1">&#39;dt&#39;</span><span class="p">:</span> <span class="n">dt</span><span class="p">,</span>
                      <span class="s1">&#39;low_frequency_cutoff&#39;</span><span class="p">:</span> <span class="n">excitation_min_frequency</span><span class="p">,</span>
                      <span class="s1">&#39;high_frequency_cutoff&#39;</span><span class="p">:</span> <span class="n">bandwidth</span> <span class="k">if</span> <span class="n">excitation_max_frequency</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">excitation_max_frequency</span><span class="p">}</span>
            <span class="n">kwargs</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">generator_kwargs</span><span class="p">)</span>
            <span class="n">signal_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">generator</span><span class="o">.</span><span class="n">burst_random</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_averages</span><span class="p">)]</span>
            <span class="n">full_list</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">signal</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">signal_list</span><span class="p">):</span>
                <span class="n">full_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">num_signals</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">extra_time_between_frames</span> <span class="o">*</span> <span class="n">sample_rate</span><span class="p">))))</span>
                <span class="n">full_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">signal</span><span class="p">)</span>
            <span class="n">signals</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">full_list</span><span class="p">,</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">excitation</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;chirp&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">num_signals</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Warning: Chirp generally not recommended for multi-reference excitation.&#39;</span><span class="p">)</span>
            <span class="n">kwargs</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;frequency_min&#39;</span><span class="p">:</span> <span class="mi">0</span> <span class="k">if</span> <span class="n">excitation_min_frequency</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">excitation_min_frequency</span><span class="p">,</span>
                      <span class="s1">&#39;frequency_max&#39;</span><span class="p">:</span> <span class="n">bandwidth</span> <span class="k">if</span> <span class="n">excitation_max_frequency</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">excitation_max_frequency</span><span class="p">,</span>
                      <span class="s1">&#39;signal_length&#39;</span><span class="p">:</span> <span class="n">frame_time</span><span class="p">,</span>
                      <span class="s1">&#39;dt&#39;</span><span class="p">:</span> <span class="n">dt</span><span class="p">}</span>
            <span class="n">kwargs</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">generator_kwargs</span><span class="p">)</span>
            <span class="n">signals</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span>
                <span class="n">generator</span><span class="o">.</span><span class="n">chirp</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_signals</span><span class="p">)</span>
            <span class="p">])</span> <span class="o">*</span> <span class="n">excitation_level</span>
            <span class="n">signals</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span><span class="n">signals</span><span class="p">,</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="n">num_averages</span> <span class="o">+</span>
                              <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">steady_state_time</span> <span class="o">/</span> <span class="n">frame_time</span><span class="p">))])</span>
        <span class="k">elif</span> <span class="n">excitation</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;hammer&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">num_signals</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span>
                    <span class="s1">&#39;Warning: Hammer impact generally not recommended for multi-reference excitation, consider multi-hammer instead&#39;</span><span class="p">)</span>
            <span class="n">pulse_width</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">/</span> <span class="p">(</span><span class="n">bandwidth</span> <span class="k">if</span> <span class="n">excitation_max_frequency</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">excitation_max_frequency</span><span class="p">)</span>
            <span class="n">signal_length</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">frame_length</span> <span class="o">*</span> <span class="n">integration_oversample</span> <span class="o">*</span> <span class="n">num_averages</span> <span class="o">+</span> <span class="p">(</span><span class="n">num_averages</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
                                <span class="o">*</span> <span class="n">extra_time_between_frames</span> <span class="o">*</span> <span class="n">sample_rate</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">pulse_width</span> <span class="o">*</span> <span class="n">sample_rate</span><span class="p">)</span>
            <span class="n">pulse_times</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">num_averages</span><span class="p">)[</span>
                <span class="p">:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">frame_time</span> <span class="o">+</span> <span class="n">extra_time_between_frames</span><span class="p">)</span> <span class="o">+</span> <span class="n">pulse_width</span> <span class="o">+</span> <span class="n">extra_time_between_frames</span>
            <span class="n">kwargs</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;signal_length&#39;</span><span class="p">:</span> <span class="n">signal_length</span><span class="p">,</span>
                      <span class="s1">&#39;pulse_time&#39;</span><span class="p">:</span> <span class="n">pulse_times</span><span class="p">,</span>
                      <span class="s1">&#39;pulse_width&#39;</span><span class="p">:</span> <span class="n">pulse_width</span><span class="p">,</span>
                      <span class="s1">&#39;pulse_peak&#39;</span><span class="p">:</span> <span class="n">excitation_level</span><span class="p">,</span>
                      <span class="s1">&#39;dt&#39;</span><span class="p">:</span> <span class="n">dt</span><span class="p">,</span>
                      <span class="s1">&#39;sine_exponent&#39;</span><span class="p">:</span> <span class="mi">2</span><span class="p">}</span>
            <span class="n">kwargs</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">generator_kwargs</span><span class="p">)</span>
            <span class="n">signals</span> <span class="o">=</span> <span class="n">generator</span><span class="o">.</span><span class="n">pulse</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="n">signals</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span><span class="n">signals</span><span class="p">,</span> <span class="p">[</span><span class="n">num_signals</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>
        <span class="k">elif</span> <span class="n">excitation</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;multi-hammer&#39;</span><span class="p">:</span>
            <span class="n">signal_length</span> <span class="o">=</span> <span class="n">frame_length</span> <span class="o">*</span> <span class="n">integration_oversample</span>
            <span class="n">pulse_width</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">/</span> <span class="p">(</span><span class="n">bandwidth</span> <span class="k">if</span> <span class="n">excitation_max_frequency</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">excitation_max_frequency</span><span class="p">)</span>
            <span class="n">signals</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_signals</span><span class="p">):</span>
                <span class="n">signals</span><span class="o">.</span><span class="n">append</span><span class="p">([])</span>
                <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_averages</span><span class="p">):</span>
                    <span class="n">pulse_times</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="n">last_pulse</span> <span class="o">=</span> <span class="mi">0</span>
                    <span class="k">while</span> <span class="n">last_pulse</span> <span class="o">&lt;</span> <span class="n">frame_time</span> <span class="o">*</span> <span class="n">signal_fraction</span><span class="p">:</span>
                        <span class="n">next_pulse</span> <span class="o">=</span> <span class="n">last_pulse</span> <span class="o">+</span> <span class="n">pulse_width</span> <span class="o">*</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">rand</span><span class="p">()</span> <span class="o">*</span> <span class="n">multihammer_impact_spacing_factor</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
                        <span class="n">pulse_times</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">next_pulse</span><span class="p">)</span>
                        <span class="n">last_pulse</span> <span class="o">=</span> <span class="n">next_pulse</span>
                    <span class="n">pulse_times</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">pulse_times</span><span class="p">)</span>
                    <span class="n">pulse_times</span> <span class="o">=</span> <span class="n">pulse_times</span><span class="p">[</span><span class="n">pulse_times</span> <span class="o">&lt;</span>
                                              <span class="n">frame_time</span> <span class="o">*</span> <span class="n">signal_fraction</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span>
                    <span class="n">kwargs</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;signal_length&#39;</span><span class="p">:</span> <span class="n">signal_length</span><span class="p">,</span>
                              <span class="s1">&#39;pulse_time&#39;</span><span class="p">:</span> <span class="n">pulse_times</span><span class="p">,</span>
                              <span class="s1">&#39;pulse_width&#39;</span><span class="p">:</span> <span class="n">pulse_width</span><span class="p">,</span>
                              <span class="s1">&#39;pulse_peak&#39;</span><span class="p">:</span> <span class="n">excitation_level</span><span class="p">,</span>
                              <span class="s1">&#39;dt&#39;</span><span class="p">:</span> <span class="n">dt</span><span class="p">,</span>
                              <span class="s1">&#39;sine_exponent&#39;</span><span class="p">:</span> <span class="mi">2</span><span class="p">}</span>
                    <span class="n">kwargs</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">generator_kwargs</span><span class="p">)</span>
                    <span class="n">signal</span> <span class="o">=</span> <span class="n">generator</span><span class="o">.</span><span class="n">pulse</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
                    <span class="n">signals</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">extra_time_between_frames</span> <span class="o">*</span> <span class="n">sample_rate</span><span class="p">)))</span>
                    <span class="n">signals</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">signal</span><span class="p">)</span>
                <span class="n">signals</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">extra_time_between_frames</span> <span class="o">*</span> <span class="n">sample_rate</span><span class="p">)))</span>
                <span class="n">signals</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">signals</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">signals</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">signals</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">excitation</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;sine&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">num_signals</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span>
                    <span class="s1">&#39;Warning: Sine signal generally not recommended for multi-reference excitation&#39;</span><span class="p">)</span>
            <span class="n">frequencies</span> <span class="o">=</span> <span class="n">excitation_max_frequency</span> <span class="k">if</span> <span class="n">excitation_min_frequency</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">excitation_min_frequency</span>
            <span class="n">num_samples</span> <span class="o">=</span> <span class="n">frame_length</span> <span class="o">*</span> <span class="n">integration_oversample</span> <span class="o">*</span> <span class="n">num_averages</span> <span class="o">+</span> <span class="nb">int</span><span class="p">(</span><span class="n">steady_state_time</span> <span class="o">*</span> <span class="n">sample_rate</span><span class="p">)</span>
            <span class="n">kwargs</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;frequencies&#39;</span><span class="p">:</span> <span class="n">frequencies</span><span class="p">,</span>
                      <span class="s1">&#39;dt&#39;</span><span class="p">:</span> <span class="n">dt</span><span class="p">,</span>
                      <span class="s1">&#39;num_samples&#39;</span><span class="p">:</span> <span class="n">num_samples</span><span class="p">,</span>
                      <span class="s1">&#39;amplitudes&#39;</span><span class="p">:</span> <span class="n">excitation_level</span><span class="p">}</span>
            <span class="n">kwargs</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">generator_kwargs</span><span class="p">)</span>
            <span class="n">signals</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span><span class="n">generator</span><span class="o">.</span><span class="n">sine</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">),</span> <span class="p">(</span><span class="n">num_signals</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
        <span class="c1"># Set up the integration</span>
        <span class="kn">from</span><span class="w"> </span><span class="nn">.sdynpy_data</span><span class="w"> </span><span class="kn">import</span> <span class="n">time_history_array</span>
        <span class="n">abscissa</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">signals</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span><span class="o">*</span><span class="n">dt</span>
        <span class="n">references</span> <span class="o">=</span> <span class="n">time_history_array</span><span class="p">(</span><span class="n">abscissa</span><span class="p">,</span><span class="n">signals</span><span class="p">,</span><span class="n">references</span><span class="p">[:,</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">])</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">responses</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">time_integrate</span><span class="p">(</span>
            <span class="n">references</span><span class="p">,</span> <span class="n">responses</span><span class="p">,</span> <span class="n">extra_outputs</span> <span class="o">=</span> <span class="n">extra_outputs</span><span class="p">)</span>
        <span class="c1"># Now add noise</span>
        <span class="n">responses</span><span class="o">.</span><span class="n">ordinate</span> <span class="o">+=</span> <span class="n">response_noise_level</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="o">*</span><span class="n">responses</span><span class="o">.</span><span class="n">ordinate</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
        <span class="n">references</span><span class="o">.</span><span class="n">ordinate</span> <span class="o">+=</span> <span class="n">excitation_noise_level</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="o">*</span><span class="n">references</span><span class="o">.</span><span class="n">ordinate</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
        <span class="c1"># Filter with antialiasing filters, divide filter order by 2 because of filtfilt</span>
        <span class="k">if</span> <span class="n">antialias_filter_order</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">lowpass_b</span><span class="p">,</span> <span class="n">lowpass_a</span> <span class="o">=</span> <span class="n">butter</span><span class="p">(</span><span class="n">antialias_filter_order</span> <span class="o">//</span> <span class="mi">2</span><span class="p">,</span>
                                          <span class="n">antialias_filter_cutoff_factor</span> <span class="o">*</span> <span class="n">bandwidth</span><span class="p">,</span> <span class="n">fs</span><span class="o">=</span><span class="n">sample_rate</span><span class="p">)</span>
            <span class="n">responses</span><span class="o">.</span><span class="n">ordinate</span> <span class="o">=</span> <span class="n">filtfilt</span><span class="p">(</span><span class="n">lowpass_b</span><span class="p">,</span> <span class="n">lowpass_a</span><span class="p">,</span> <span class="n">responses</span><span class="o">.</span><span class="n">ordinate</span><span class="p">)</span>
            <span class="n">references</span><span class="o">.</span><span class="n">ordinate</span> <span class="o">=</span> <span class="n">filtfilt</span><span class="p">(</span><span class="n">lowpass_b</span><span class="p">,</span> <span class="n">lowpass_a</span><span class="p">,</span> <span class="n">references</span><span class="o">.</span><span class="n">ordinate</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">integration_oversample</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">responses</span> <span class="o">=</span> <span class="n">responses</span><span class="o">.</span><span class="n">downsample</span><span class="p">(</span><span class="n">integration_oversample</span><span class="p">)</span>
            <span class="n">references</span> <span class="o">=</span> <span class="n">references</span><span class="o">.</span><span class="n">downsample</span><span class="p">(</span><span class="n">integration_oversample</span><span class="p">)</span>
        <span class="n">responses</span> <span class="o">=</span> <span class="n">responses</span><span class="o">.</span><span class="n">extract_elements_by_abscissa</span><span class="p">(</span><span class="n">steady_state_time</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">)</span>
        <span class="n">references</span> <span class="o">=</span> <span class="n">references</span><span class="o">.</span><span class="n">extract_elements_by_abscissa</span><span class="p">(</span><span class="n">steady_state_time</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">responses</span><span class="p">,</span> <span class="n">references</span></div></div>

    <span class="c1"># def reduce_serep(self,shapes_full,shapes_reduced):</span>
    <span class="c1">#     if isinstance(shapes_full,)</span>


<span class="n">substructure_by_position</span> <span class="o">=</span> <span class="n">System</span><span class="o">.</span><span class="n">substructure_by_position</span>
</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
<jinja2.runtime.BlockReference object at 0x7fc91eaaf310>
<img src="_images/snl.jpg" alt="Sandia National Laboratories" style="height:40px">

  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>